<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Simple {surveyIndex} example • surveyIndex</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Simple {surveyIndex} example">
<meta property="og:description" content="Prepare survey data for get_surveyidx()">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">surveyIndex</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/A-data-prep.html">Simple {surveyIndex} example</a>
    </li>
    <li>
      <a href="../articles/B-model-tuning.html">Nuances in model choices</a>
    </li>
    <li>
      <a href="../articles/C-model-comparisons.html">Compare {surveyIndex} to regular GAMs</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Simple {surveyIndex} example</h1>
            
            <h4 data-toc-skip class="date">September 13 2022</h4>
      
      
      <div class="hidden name"><code>A-data-prep.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="example-set-up-and-context">Example set up and context:<a class="anchor" aria-label="anchor" href="#example-set-up-and-context"></a>
</h2>
<p>For this example, let’s say we want to assess:</p>
<div style="display: flex;">
<div style="width:500px;">
<p><img src="https://github.com/EmilyMarkowitz-NOAA/gap_bs_data_report/blob/main/img/yellowfin_sole.png?raw=true" style="width:60.0%"></p>
</div>
<div>
<p><strong>Yellowfin Sole</strong> is a commonly caught “golden child”
species has been realitively easy to model and assess because of it’s
high abundance, large distribution over the survey area, and consistent
availability to the survey.</p>
</div>
</div>
<!-- break -->
<div style="display: flex;">
<div style="width:500px;">
<p><img src="https://github.com/EmilyMarkowitz-NOAA/gap_bs_data_report/blob/main/img/walleye_pollock.png?raw=true" style="width:75.0%"></p>
</div>
<div>
<p><strong>Walleye pollock</strong> are also common to the survey, but
their distribution and availability to the survey are driven by
density-dependence and temperature and the cold pool extent. Including
covariates in model fits could help uncover structure that could help us
better understand this specie’s abundance.</p>
</div>
</div>
<!-- break -->
<div style="display: flex;">
<div style="width:500px;">
<p><img src="https://github.com/EmilyMarkowitz-NOAA/gap_bs_data_report/blob/main/img/red_king_crab.png?raw=true" style="width:35.0%"></p>
</div>
<div>
<p><strong>Red King Crab</strong> is a “problem child” will have
patchier and less understood availability to the survey.</p>
</div>
</div>
<!-- break -->
<div class="figure">
<img src="https://raw.githubusercontent.com/afsc-gap-products/survey-live-temperature-map/main/test/_grid_bs.png" style="width:60.0%" alt=""><p class="caption">Survey grid for the eastern and northern Bering sea
bottom trawl surveys.</p>
</div>
<p>In this example, we will use data from NOAA Fisheries’ eastern Bering
sea (EBS) bottom trawl survey. The Resource Assessment and Conservation
Engineering (RACE) Division Groundfish Assessment Program (GAP) of the
Alaska Fisheries Science Center (AFSC) conducts fisheries-independent
bottom trawl surveys to assess the populations of demersal fish and crab
stocks of Alaska. Data presented here are presence-only (non-zero)
observations from those surveys and therefore CANNOT be aggregated.</p>
<p>For the sake of a simple example, we will only assess data from 2015
to 2021.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">SPECIES</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"yellowfin sole"</span>, <span class="st">"walleye pollock"</span>, <span class="st">"red king crab"</span><span class="op">)</span></span>
<span><span class="va">YEARS</span> <span class="op">&lt;-</span> <span class="fl">2015</span><span class="op">:</span><span class="fl">2021</span></span>
<span><span class="va">SRVY</span> <span class="op">&lt;-</span> <span class="st">"EBS"</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="what-data-area-we-using">1. What data area we using?<a class="anchor" aria-label="anchor" href="#what-data-area-we-using"></a>
</h2>
<p>Here, we use the public facing data from the <a href="https://www.fisheries.noaa.gov/foss/f?p=215:29:5480997826449::NO:::" class="external-link">NOAA
AFSC groundfish Bering sea bottom trawl survey</a>. For more information
about how these data were compiled, see <a href="https://github.com/afsc-gap-products/gap_public_data" class="external-link">afsc-gap-products
GitHub repo</a>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu">surveyIndex</span><span class="fu">::</span><span class="va"><a href="../reference/noaa_afsc_public_foss.html">noaa_afsc_public_foss</a></span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">srvy</span> <span class="op">==</span> <span class="va">SRVY</span> <span class="op">&amp;</span></span>
<span>                  <span class="va">year</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">YEARS</span> <span class="op">&amp;</span></span>
<span>                  <span class="va">common_name</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">SPECIES</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>hauljoin <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">stratum</span>, <span class="st">"_"</span>, <span class="va">station</span>, <span class="st">"_"</span>, <span class="va">date_time</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span></span>
<span>    <span class="va">year</span>, <span class="va">date_time</span>, <span class="va">latitude_dd</span>, <span class="va">longitude_dd</span>, <span class="co"># spatiotemproal data</span></span>
<span>    <span class="va">cpue_kgha</span>, <span class="va">common_name</span>, <span class="co"># catch data</span></span>
<span>    <span class="va">bottom_temperature_c</span>, <span class="va">depth_m</span>, <span class="co"># possible covariate data</span></span>
<span>    <span class="va">srvy</span>, <span class="va">area_swept_ha</span>, <span class="va">duration_hr</span>, <span class="va">vessel_id</span>, <span class="va">hauljoin</span> <span class="co"># haul/effort data)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 13</span></span></span>
<span><span class="co">#&gt;    year date_time  latit…¹ longi…² cpue_…³ commo…⁴ botto…⁵ depth_m srvy  area_…⁶</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>  <span style="text-decoration: underline;">2</span>016 05/31/201…    56.3   -<span style="color: #BB0000;">161.</span>    1.14 red ki…     6.1      54 EBS      5.17</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span>  <span style="text-decoration: underline;">2</span>016 05/31/201…    56.3   -<span style="color: #BB0000;">161.</span>  240.   walley…     6.1      54 EBS      5.17</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span>  <span style="text-decoration: underline;">2</span>016 05/31/201…    56.3   -<span style="color: #BB0000;">161.</span>  326.   yellow…     6.1      54 EBS      5.17</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span>  <span style="text-decoration: underline;">2</span>016 05/31/201…    56.0   -<span style="color: #BB0000;">162.</span>    3.98 red ki…     5.2      73 EBS      5.12</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span>  <span style="text-decoration: underline;">2</span>016 05/31/201…    56.0   -<span style="color: #BB0000;">162.</span>   61.2  walley…     5.2      73 EBS      5.12</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span>  <span style="text-decoration: underline;">2</span>016 05/31/201…    56.0   -<span style="color: #BB0000;">162.</span>  150.   yellow…     5.2      73 EBS      5.12</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># … with 3 more variables: duration_hr &lt;dbl&gt;, vessel_id &lt;dbl&gt;, hauljoin &lt;chr&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   and abbreviated variable names ¹​latitude_dd, ²​longitude_dd, ³​cpue_kgha,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   ⁴​common_name, ⁵​bottom_temperature_c, ⁶​area_swept_ha</span></span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="prepare-the-data-for-surveyindexget_surveyidx">2. Prepare the data for surveyIndex::get_surveyidx():<a class="anchor" aria-label="anchor" href="#prepare-the-data-for-surveyindexget_surveyidx"></a>
</h2>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># project spatial data</span></span>
<span><span class="va">crs_proj</span> <span class="op">&lt;-</span> <span class="st">"EPSG:3338"</span> <span class="co"># NAD83 / Alaska Albers</span></span>
<span><span class="va">crs_latlon</span> <span class="op">&lt;-</span> <span class="st">"+proj=longlat +datum=WGS84"</span> <span class="co"># decimal degrees</span></span>
<span></span>
<span><span class="va">ll</span> <span class="op">&lt;-</span> <span class="fu">surveyIndex</span><span class="fu">::</span><span class="fu"><a href="../reference/convert_crs.html">convert_crs</a></span><span class="op">(</span> </span>
<span>  x <span class="op">=</span> <span class="va">dat</span><span class="op">$</span><span class="va">longitude_dd</span>,</span>
<span>  y <span class="op">=</span> <span class="va">dat</span><span class="op">$</span><span class="va">latitude_dd</span>, </span>
<span>  crs_in <span class="op">=</span> <span class="va">crs_latlon</span>, </span>
<span>  crs_out <span class="op">=</span> <span class="va">crs_proj</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">YEARS</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">year</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># The surveyIndex::get_surveyidx() expects some columns to be named in a specific way</span></span>
<span><span class="va">dat_wrangled</span> <span class="op">&lt;-</span> <span class="va">dat</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span></span>
<span>    Year <span class="op">=</span> <span class="va">year</span>,</span>
<span>    wCPUE <span class="op">=</span> <span class="va">cpue_kgha</span>, </span>
<span>    COMMON_NAME <span class="op">=</span> <span class="va">common_name</span>,</span>
<span>    GEAR_TEMPERATURE <span class="op">=</span> <span class="va">bottom_temperature_c</span>, </span>
<span>    BOTTOM_DEPTH <span class="op">=</span> <span class="va">depth_m</span>,</span>
<span>    HaulDur <span class="op">=</span> <span class="va">duration_hr</span>,</span>
<span>    EFFORT <span class="op">=</span> <span class="va">area_swept_ha</span>,</span>
<span>    Ship <span class="op">=</span> <span class="va">vessel_id</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span> </span>
<span>    <span class="co"># create some other vars</span></span>
<span>    Lon <span class="op">=</span> <span class="va">longitude_dd</span>, </span>
<span>    Lat <span class="op">=</span> <span class="va">latitude_dd</span>, </span>
<span>    lon <span class="op">=</span> <span class="va">ll</span><span class="op">$</span><span class="va">X</span>,</span>
<span>    lat <span class="op">=</span> <span class="va">ll</span><span class="op">$</span><span class="va">Y</span>,</span>
<span>    sx <span class="op">=</span> <span class="op">(</span><span class="op">(</span><span class="va">longitude_dd</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">longitude_dd</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="fl">1000</span><span class="op">)</span>,</span>
<span>    sy <span class="op">=</span> <span class="op">(</span><span class="op">(</span><span class="va">latitude_dd</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">latitude_dd</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="fl">1000</span><span class="op">)</span>, </span>
<span>    ctime <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">Year</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    date_time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">date_time</span>, format <span class="op">=</span> <span class="st">"%m/%d/%Y %H:%M:%S"</span><span class="op">)</span>, </span>
<span>    hour <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="va">date_time</span>,<span class="st">"%H"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    minute <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="va">date_time</span>,<span class="st">"%M"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    day <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="va">date_time</span>,<span class="st">"%d"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    month <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="va">date_time</span>,<span class="st">"%m"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    TimeShotHour <span class="op">=</span> <span class="va">hour</span> <span class="op">+</span> <span class="va">minute</span><span class="op">/</span><span class="fl">60</span>,</span>
<span>    timeOfYear <span class="op">=</span> <span class="op">(</span><span class="va">month</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="fl">1</span><span class="op">/</span><span class="fl">12</span> <span class="op">+</span> <span class="op">(</span><span class="va">day</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span><span class="op">/</span><span class="fl">365</span>,   </span>
<span>    </span>
<span>    <span class="co"># add some dummy vars and create some other vars</span></span>
<span>    Country <span class="op">=</span> <span class="st">"USA"</span>,</span>
<span>    Gear <span class="op">=</span> <span class="st">"dummy"</span>,</span>
<span>    Quarter <span class="op">=</span> <span class="st">"2"</span><span class="op">)</span>  <span class="op">%&gt;%</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span><span class="fu">across</span><span class="op">(</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Year"</span>, <span class="st">"Ship"</span>, <span class="st">"COMMON_NAME"</span><span class="op">)</span><span class="op">)</span>, <span class="va">as.factor</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">wCPUE</span>, <span class="va">GEAR_TEMPERATURE</span>, <span class="va">BOTTOM_DEPTH</span>, <span class="va">COMMON_NAME</span>, <span class="va">EFFORT</span>, </span>
<span>                <span class="va">Year</span>, <span class="va">Ship</span>, <span class="va">Lon</span>, <span class="va">Lat</span>, <span class="va">lat</span>, <span class="va">lon</span>, <span class="va">sx</span>, <span class="va">sy</span>, </span>
<span>                <span class="va">ctime</span>, <span class="va">TimeShotHour</span>, <span class="va">timeOfYear</span>, <span class="va">Gear</span>, <span class="va">Quarter</span>, <span class="va">HaulDur</span>, <span class="va">hauljoin</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">dat_wrangled</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 20</span></span></span>
<span><span class="co">#&gt;    wCPUE GEAR_TE…¹ BOTTO…² COMMO…³ EFFORT Year  Ship    Lon   Lat    lat     lon</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span> <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>   1.14       6.1      54 red ki…   5.17 2016  94    -<span style="color: #BB0000;">161.</span>  56.3 7.26<span style="color: #949494;">e</span>5 -<span style="color: #BB0000;">4.32</span><span style="color: #949494;">e</span>5</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> 240.         6.1      54 walley…   5.17 2016  94    -<span style="color: #BB0000;">161.</span>  56.3 7.26<span style="color: #949494;">e</span>5 -<span style="color: #BB0000;">4.32</span><span style="color: #949494;">e</span>5</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> 326.         6.1      54 yellow…   5.17 2016  94    -<span style="color: #BB0000;">161.</span>  56.3 7.26<span style="color: #949494;">e</span>5 -<span style="color: #BB0000;">4.32</span><span style="color: #949494;">e</span>5</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span>   3.98       5.2      73 red ki…   5.12 2016  162   -<span style="color: #BB0000;">162.</span>  56.0 6.98<span style="color: #949494;">e</span>5 -<span style="color: #BB0000;">5.16</span><span style="color: #949494;">e</span>5</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span>  61.2        5.2      73 walley…   5.12 2016  162   -<span style="color: #BB0000;">162.</span>  56.0 6.98<span style="color: #949494;">e</span>5 -<span style="color: #BB0000;">5.16</span><span style="color: #949494;">e</span>5</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> 150.         5.2      73 yellow…   5.12 2016  162   -<span style="color: #BB0000;">162.</span>  56.0 6.98<span style="color: #949494;">e</span>5 -<span style="color: #BB0000;">5.16</span><span style="color: #949494;">e</span>5</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># … with 9 more variables: sx &lt;dbl&gt;, sy &lt;dbl&gt;, ctime &lt;dbl&gt;, TimeShotHour &lt;dbl&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   timeOfYear &lt;dbl&gt;, Gear &lt;chr&gt;, Quarter &lt;chr&gt;, HaulDur &lt;dbl&gt;, hauljoin &lt;chr&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   and abbreviated variable names ¹​GEAR_TEMPERATURE, ²​BOTTOM_DEPTH,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   ³​COMMON_NAME</span></span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="define-representitive-station-points-to-fit-and-predict-the-model-at">3. Define representitive station points to fit and predict the model
at<a class="anchor" aria-label="anchor" href="#define-representitive-station-points-to-fit-and-predict-the-model-at"></a>
</h2>
<p>Since surveys are not done at the same <em>exact</em> location each
year (it’s the intention, but impossible in practice), we need to define
what representative latitudes and longitudes we are going to predict
at.</p>
<p>These are the same prediction grids AFSC uses for their 2021 <a href="https://github.com/James-Thorson-NOAA/VAST" class="external-link">VAST model-based
indices</a> (which is subject to change - do not use this without
asking/checking that this is still current!).</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pred_grid</span> <span class="op">&lt;-</span> <span class="fu">surveyIndex</span><span class="fu">::</span><span class="va"><a href="../reference/pred_grid_ebs.html">pred_grid_ebs</a></span></span>
<span></span>
<span><span class="va">ll</span> <span class="op">&lt;-</span> <span class="fu">surveyIndex</span><span class="fu">::</span><span class="fu"><a href="../reference/convert_crs.html">convert_crs</a></span><span class="op">(</span> </span>
<span>  x <span class="op">=</span> <span class="va">pred_grid</span><span class="op">$</span><span class="va">lon</span>,</span>
<span>  y <span class="op">=</span> <span class="va">pred_grid</span><span class="op">$</span><span class="va">lat</span>, </span>
<span>  crs_in <span class="op">=</span> <span class="va">crs_latlon</span>, </span>
<span>  crs_out <span class="op">=</span> <span class="va">crs_proj</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">pred_grid</span> <span class="op">&lt;-</span> <span class="va">pred_grid</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span> </span>
<span>    lon <span class="op">=</span> <span class="va">ll</span><span class="op">$</span><span class="va">X</span>,</span>
<span>    lat <span class="op">=</span> <span class="va">ll</span><span class="op">$</span><span class="va">Y</span>,</span>
<span>    sx <span class="op">=</span> <span class="op">(</span><span class="op">(</span><span class="va">lon</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">lon</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="fl">1000</span><span class="op">)</span>,</span>
<span>    sy <span class="op">=</span> <span class="op">(</span><span class="op">(</span><span class="va">lat</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">lat</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="fl">1000</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">pred_grid</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 5</span></span></span>
<span><span class="co">#&gt;         lon      lat Shape_Area    sx    sy</span></span>
<span><span class="co">#&gt;       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> -<span style="color: #BB0000;">1</span><span style="color: #BB0000; text-decoration: underline;">133</span><span style="color: #BB0000;">214.</span> 1<span style="text-decoration: underline;">542</span>340.   2<span style="text-decoration: underline;">449</span>160. -<span style="color: #BB0000;">290.</span>  517.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> -<span style="color: #BB0000;">1</span><span style="color: #BB0000; text-decoration: underline;">129</span><span style="color: #BB0000;">510.</span> 1<span style="text-decoration: underline;">542</span>340.   9<span style="text-decoration: underline;">298</span>535. -<span style="color: #BB0000;">287.</span>  517.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> -<span style="color: #BB0000;">1</span><span style="color: #BB0000; text-decoration: underline;">125</span><span style="color: #BB0000;">806.</span> 1<span style="text-decoration: underline;">542</span>340.   9<span style="text-decoration: underline;">749</span>166. -<span style="color: #BB0000;">283.</span>  517.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> -<span style="color: #BB0000;">1</span><span style="color: #BB0000; text-decoration: underline;">122</span><span style="color: #BB0000;">102.</span> 1<span style="text-decoration: underline;">542</span>340.   5<span style="text-decoration: underline;">383</span>834. -<span style="color: #BB0000;">279.</span>  517.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> -<span style="color: #BB0000;">1</span><span style="color: #BB0000; text-decoration: underline;">118</span><span style="color: #BB0000;">398.</span> 1<span style="text-decoration: underline;">542</span>340.   1<span style="text-decoration: underline;">173</span>734. -<span style="color: #BB0000;">275.</span>  517.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> -<span style="color: #BB0000;">1</span><span style="color: #BB0000; text-decoration: underline;">140</span><span style="color: #BB0000;">622.</span> 1<span style="text-decoration: underline;">538</span>636.   1<span style="text-decoration: underline;">525</span>663. -<span style="color: #BB0000;">298.</span>  513.</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="prepare-covariate-data">4. Prepare covariate data<a class="anchor" aria-label="anchor" href="#prepare-covariate-data"></a>
</h2>
<p>Here we want to match covariate data to the prediction grid.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">dat_cov</span> <span class="op">&lt;-</span> <span class="fu">surveyIndex</span><span class="fu">::</span><span class="va"><a href="../reference/pred_grid_ebs.html">pred_grid_ebs</a></span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">Shape_Area</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span> </span>
<span>    sx <span class="op">=</span> <span class="op">(</span><span class="op">(</span><span class="va">lon</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">lon</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="fl">1000</span><span class="op">)</span>,</span>
<span>    sy <span class="op">=</span> <span class="op">(</span><span class="op">(</span><span class="va">lat</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">lat</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="fl">1000</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">sp_extrap_raster</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sp/man/SpatialPoints.html" class="external-link">SpatialPoints</a></span><span class="op">(</span></span>
<span>  coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/sp/man/coordinates.html" class="external-link">coordinates</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">dat_cov</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"lon"</span>, <span class="st">"lat"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>, </span>
<span>  proj4string <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/sp/man/CRS-class.html" class="external-link">CRS</a></span><span class="op">(</span><span class="va">crs_latlon</span><span class="op">)</span> <span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="a--data-that-varies-over-only-space-depth">4a. Data that varies over only space (depth)<a class="anchor" aria-label="anchor" href="#a--data-that-varies-over-only-space-depth"></a>
</h3>
<p>Here in the Bering sea, the depth rarely changes. The modeler may
consider making this variable time-varying as well if they are say, in
the Gulf of Alaska or the Aleutian Islands where currents and island
formation can markedly change depth.</p>
<p>For this, we are going to create a raster of depth in the Bering sea
from the survey data so we can merge that into the dataset at the
prediction grid lat/lons.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="va">dat_wrangled</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">Lon</span>, <span class="va">Lat</span>, <span class="va">BOTTOM_DEPTH</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/na.fail.html" class="external-link">na.omit</a></span><span class="op">(</span><span class="op">)</span>  <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">.</span>, </span>
<span>               coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Lon"</span>, y <span class="op">=</span> <span class="st">"Lat"</span><span class="op">)</span>, </span>
<span>               crs <span class="op">=</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html" class="external-link">st_crs</a></span><span class="op">(</span><span class="va">crs_latlon</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">idw_fit</span> <span class="op">&lt;-</span> <span class="fu">gstat</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/gstat/man/gstat.html" class="external-link">gstat</a></span><span class="op">(</span>formula <span class="op">=</span> <span class="va">BOTTOM_DEPTH</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>                        locations <span class="op">=</span> <span class="va">x</span>,</span>
<span>                        nmax <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># stn_predict &lt;- raster::predict(idw_fit, x)</span></span>
<span></span>
<span><span class="va">extrap_data0</span> <span class="op">&lt;-</span> <span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span></span>
<span>  <span class="va">idw_fit</span>, <span class="va">sp_extrap_raster</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co"># as(sp_extrap_raster, Class = "SpatialPoints")) %&gt;%</span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span>crs <span class="op">=</span> <span class="va">crs_latlon</span><span class="op">)</span>  <span class="op">%&gt;%</span></span>
<span>  <span class="fu">stars</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_rasterize.html" class="external-link">st_rasterize</a></span><span class="op">(</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">extrap_data</span> <span class="op">&lt;-</span> <span class="fu">stars</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_extract.html" class="external-link">st_extract</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">extrap_data0</span>,</span>
<span>                                 at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">dat_cov</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"lon"</span>, <span class="st">"lat"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># to make future runs of this faster:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/save.html" class="external-link">save</a></span><span class="op">(</span><span class="va">extrap_data0</span>, <span class="va">extrap_data</span>, </span>
<span>     file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"../inst/VigA_bottom_depth_raster_"</span>,</span>
<span>                   <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">YEARS</span><span class="op">)</span>,<span class="st">"-"</span>,<span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">YEARS</span><span class="op">)</span>, <span class="st">".rdata"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Just so we can see what we are looking at:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">extrap_data0</span>, main <span class="op">=</span> <span class="st">"Interpolated Bottom Depths"</span><span class="op">)</span> </span></code></pre></div>
<p><img src="A-data-prep_files/figure-html/covar_depth_show-1.png" width="700"></p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">dat_cov</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind.data.frame</a></span><span class="op">(</span><span class="va">dat_cov</span>, </span>
<span>                            <span class="st">"BOTTOM_DEPTH"</span> <span class="op">=</span> <span class="va">extrap_data</span><span class="op">$</span><span class="va">var1.pred</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/na.fail.html" class="external-link">na.omit</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">dat_cov</span><span class="op">)</span></span>
<span><span class="co">#&gt;         lon      lat           sx          sy BOTTOM_DEPTH</span></span>
<span><span class="co">#&gt; 1 -176.2068 62.13518 -0.007481089 0.003842524     92.30228</span></span>
<span><span class="co">#&gt; 2 -176.1395 62.14603 -0.007413772 0.003853379     92.28437</span></span>
<span><span class="co">#&gt; 3 -176.0722 62.15686 -0.007346407 0.003864203     92.27470</span></span>
<span><span class="co">#&gt; 4 -176.0047 62.16765 -0.007278995 0.003874995     91.78201</span></span>
<span><span class="co">#&gt; 5 -175.9373 62.17841 -0.007211535 0.003885756     91.50777</span></span>
<span><span class="co">#&gt; 6 -176.3179 62.08210 -0.007592106 0.003789448     92.30235</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="b--data-that-varies-over-space-and-time-bottom-temperature">4b. Data that varies over space and time (bottom temperature)<a class="anchor" aria-label="anchor" href="#b--data-that-varies-over-space-and-time-bottom-temperature"></a>
</h3>
<p>Here, bottom temperature, and thereby the cold pool extent, have been
show to drive the distribution of many species. This is especially true
for walleye pollock.</p>
<p>For this we are going to lean on our in-house prepared validated and
pre-prepared <a href="https://github.com/afsc-gap-products/coldpool" class="external-link">{coldpool} R
package</a> (S. Rohan, L. Barnett, and N. Charriere). This data
interpolates over the whole area of the survey so there are no missing
data.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu">coldpool</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/coldpool/man/ebs_bottom_temperature.html" class="external-link">ebs_bottom_temperature</a></span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span> <span class="co"># Just so we can see what we are looking at: </span></span></code></pre></div>
<p><img src="A-data-prep_files/figure-html/covar_bt-1.png" width="700"></p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">tmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">YEARS</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">tmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">tmp</span>, </span>
<span>           <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span>pattern <span class="op">=</span> <span class="va">YEARS</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="fu">coldpool</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/coldpool/man/ebs_bottom_temperature.html" class="external-link">ebs_bottom_temperature</a></span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">extrap_data0</span> <span class="op">&lt;-</span> <span class="fu">coldpool</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/coldpool/man/ebs_bottom_temperature.html" class="external-link">ebs_bottom_temperature</a></span><span class="op">[[</span><span class="va">tmp</span><span class="op">]</span><span class="op">]</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">as</span><span class="op">(</span><span class="va">.</span>, Class <span class="op">=</span> <span class="st">"SpatialPointsDataFrame"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span>crs <span class="op">=</span> <span class="va">crs_latlon</span><span class="op">)</span>  <span class="op">%&gt;%</span></span>
<span>  <span class="fu">stars</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_rasterize.html" class="external-link">st_rasterize</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">stars</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_extract.html" class="external-link">st_extract</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">.</span>,</span>
<span>                    at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">dat_cov</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"lon"</span>, <span class="st">"lat"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">extrap_data0</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"GEAR_TEMPERATURE"</span>, <span class="va">YEARS</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dat_cov</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html" class="external-link">bind_cols</a></span><span class="op">(</span><span class="va">dat_cov</span>, <span class="va">extrap_data0</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/na.fail.html" class="external-link">na.omit</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">dat_cov</span><span class="op">)</span></span>
<span><span class="co">#&gt;          lon      lat           sx          sy BOTTOM_DEPTH</span></span>
<span><span class="co">#&gt; 7  -176.2507 62.09301 -0.007524943 0.003800355     92.30377</span></span>
<span><span class="co">#&gt; 11 -175.9816 62.13632 -0.007255819 0.003843669     91.79176</span></span>
<span><span class="co">#&gt; 12 -175.9142 62.14707 -0.007188420 0.003854419     91.50379</span></span>
<span><span class="co">#&gt; 18 -176.2944 62.05083 -0.007568678 0.003758174     92.31231</span></span>
<span><span class="co">#&gt; 20 -176.1602 62.07259 -0.007434424 0.003779935     92.31936</span></span>
<span><span class="co">#&gt; 22 -176.0257 62.09423 -0.007299981 0.003801570     92.29796</span></span>
<span><span class="co">#&gt;    GEAR_TEMPERATURE2015 GEAR_TEMPERATURE2016 GEAR_TEMPERATURE2017</span></span>
<span><span class="co">#&gt; 7            0.06603578          -0.08488923           0.42137590</span></span>
<span><span class="co">#&gt; 11          -0.19408995          -0.40033633           0.13686910</span></span>
<span><span class="co">#&gt; 12          -0.27335623          -0.50372183           0.01403086</span></span>
<span><span class="co">#&gt; 18           0.13692820           0.04827412           0.49719471</span></span>
<span><span class="co">#&gt; 20          -0.02377643          -0.18901448           0.33807641</span></span>
<span><span class="co">#&gt; 22          -0.11071504          -0.29478970           0.24448346</span></span>
<span><span class="co">#&gt;    GEAR_TEMPERATURE2018 GEAR_TEMPERATURE2019 GEAR_TEMPERATURE2021</span></span>
<span><span class="co">#&gt; 7              2.109732             1.372879           0.30572507</span></span>
<span><span class="co">#&gt; 11             2.041945             1.190976           0.12316012</span></span>
<span><span class="co">#&gt; 12             2.020781             1.117297           0.06606124</span></span>
<span><span class="co">#&gt; 18             2.136764             1.444568           0.39687258</span></span>
<span><span class="co">#&gt; 20             2.087453             1.317465           0.24463494</span></span>
<span><span class="co">#&gt; 22             2.064520             1.257273           0.18322888</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="datras-structure">5. DATRAS structure<a class="anchor" aria-label="anchor" href="#datras-structure"></a>
</h2>
<div class="section level3">
<h3 id="b--catch-data">5b. Catch Data<a class="anchor" aria-label="anchor" href="#b--catch-data"></a>
</h3>
<p>Now, we need to fill in the data with the zeros!</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Identify vars that will be used --------------------------------------------</span></span>
<span></span>
<span><span class="va">varsbyyr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span> <span class="co"># c("GEAR_TEMPERATURE", "cpi")</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span>pattern <span class="op">=</span> <span class="st">"[0-9]+"</span>, </span>
<span>       replacement <span class="op">=</span> <span class="st">""</span>, </span>
<span>       x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">dat_cov</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">dat_cov</span><span class="op">)</span>, </span>
<span>                                pattern <span class="op">=</span> <span class="st">"[0-9]+"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">vars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span> <span class="co"># c("BOTTOM_DEPTH")</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">dat_cov</span><span class="op">)</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">dat_cov</span><span class="op">)</span>, </span>
<span>                        pattern <span class="op">=</span> <span class="st">"[0-9]+"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">vars</span> <span class="op">&lt;-</span> <span class="va">vars</span><span class="op">[</span><span class="op">!</span><span class="op">(</span><span class="va">vars</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"LONG"</span>, <span class="st">"LAT"</span>, <span class="st">"lon"</span>, <span class="st">"lat"</span>, <span class="st">"sx"</span>, <span class="st">"sy"</span><span class="op">)</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co">## Fill catch data with zeros ---------------------------------------------------------</span></span>
<span></span>
<span><span class="va">data_hauls</span> <span class="op">&lt;-</span> <span class="va">dat_wrangled</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">Year</span>, <span class="va">sx</span>, <span class="va">sy</span>, </span>
<span>                <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/all_of.html" class="external-link">all_of</a></span><span class="op">(</span><span class="va">varsbyyr</span><span class="op">)</span>, <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/all_of.html" class="external-link">all_of</a></span><span class="op">(</span><span class="va">vars</span><span class="op">)</span>, </span>
<span>                <span class="va">Ship</span>, <span class="va">hauljoin</span>, </span>
<span>                <span class="va">lat</span>, <span class="va">lon</span>, <span class="va">Lat</span>, <span class="va">Lon</span>, </span>
<span>                <span class="va">ctime</span>, <span class="va">TimeShotHour</span>, <span class="va">timeOfYear</span>, <span class="va">Gear</span>, <span class="va">Quarter</span>, </span>
<span>                <span class="va">EFFORT</span>, <span class="va">HaulDur</span><span class="op">)</span>  <span class="op">%&gt;%</span> </span>
<span>  <span class="co"># dplyr::filter(!is.na(GEAR_TEMPERATURE)) %&gt;% </span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/na.fail.html" class="external-link">na.omit</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">data_catch</span> <span class="op">&lt;-</span> <span class="va">dat_wrangled</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">COMMON_NAME</span>, <span class="va">wCPUE</span>, <span class="va">hauljoin</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dat_catch_haul</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">data_hauls</span>, </span>
<span>                                   y <span class="op">=</span> <span class="va">data_catch</span>, </span>
<span>                                   by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hauljoin"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>wCPUE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">wCPUE</span><span class="op">)</span>, <span class="fl">0</span>, <span class="va">wCPUE</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">dat_catch_haul</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 20</span></span></span>
<span><span class="co">#&gt;   Year       sx       sy GEAR_TEMPE…¹ BOTTO…² Ship  haulj…³    lat     lon   Lat</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> 2016  0.006<span style="text-decoration: underline;">47</span> -<span style="color: #BB0000;">0.001</span><span style="color: #BB0000; text-decoration: underline;">83</span>          6.1      54 94    10_E-1… 7.26<span style="color: #949494;">e</span>5 -<span style="color: #BB0000;">4.32</span><span style="color: #949494;">e</span>5  56.3</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> 2016  0.006<span style="text-decoration: underline;">47</span> -<span style="color: #BB0000;">0.001</span><span style="color: #BB0000; text-decoration: underline;">83</span>          6.1      54 94    10_E-1… 7.26<span style="color: #949494;">e</span>5 -<span style="color: #BB0000;">4.32</span><span style="color: #949494;">e</span>5  56.3</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> 2016  0.006<span style="text-decoration: underline;">47</span> -<span style="color: #BB0000;">0.001</span><span style="color: #BB0000; text-decoration: underline;">83</span>          6.1      54 94    10_E-1… 7.26<span style="color: #949494;">e</span>5 -<span style="color: #BB0000;">4.32</span><span style="color: #949494;">e</span>5  56.3</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> 2016  0.005<span style="text-decoration: underline;">18</span> -<span style="color: #BB0000;">0.002</span><span style="color: #BB0000; text-decoration: underline;">17</span>          5.2      73 162   31_D-1… 6.98<span style="color: #949494;">e</span>5 -<span style="color: #BB0000;">5.16</span><span style="color: #949494;">e</span>5  56.0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> 2016  0.005<span style="text-decoration: underline;">18</span> -<span style="color: #BB0000;">0.002</span><span style="color: #BB0000; text-decoration: underline;">17</span>          5.2      73 162   31_D-1… 6.98<span style="color: #949494;">e</span>5 -<span style="color: #BB0000;">5.16</span><span style="color: #949494;">e</span>5  56.0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> 2016  0.005<span style="text-decoration: underline;">18</span> -<span style="color: #BB0000;">0.002</span><span style="color: #BB0000; text-decoration: underline;">17</span>          5.2      73 162   31_D-1… 6.98<span style="color: #949494;">e</span>5 -<span style="color: #BB0000;">5.16</span><span style="color: #949494;">e</span>5  56.0</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># … with 10 more variables: Lon &lt;dbl&gt;, ctime &lt;dbl&gt;, TimeShotHour &lt;dbl&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   timeOfYear &lt;dbl&gt;, Gear &lt;chr&gt;, Quarter &lt;chr&gt;, EFFORT &lt;dbl&gt;, HaulDur &lt;dbl&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   COMMON_NAME &lt;fct&gt;, wCPUE &lt;dbl&gt;, and abbreviated variable names</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   ¹​GEAR_TEMPERATURE, ²​BOTTOM_DEPTH, ³​hauljoin</span></span></span></code></pre></div>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">allpd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">YEARS</span>, FUN <span class="op">=</span> <span class="fu">surveyIndex</span><span class="fu">::</span><span class="va"><a href="../reference/get_prediction_grid.html">get_prediction_grid</a></span>, x <span class="op">=</span> <span class="va">dat_cov</span>, </span>
<span>                vars <span class="op">=</span> <span class="va">vars</span>, varsbyyr <span class="op">=</span> <span class="va">varsbyyr</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">allpd</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">YEARS</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">allpd</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt;          lon      lat           sx          sy BOTTOM_DEPTH GEAR_TEMPERATURE</span></span>
<span><span class="co">#&gt; 7  -176.2507 62.09301 -0.007524943 0.003800355     92.30377       0.06603578</span></span>
<span><span class="co">#&gt; 11 -175.9816 62.13632 -0.007255819 0.003843669     91.79176      -0.19408995</span></span>
<span><span class="co">#&gt; 12 -175.9142 62.14707 -0.007188420 0.003854419     91.50379      -0.27335623</span></span>
<span><span class="co">#&gt; 18 -176.2944 62.05083 -0.007568678 0.003758174     92.31231       0.13692820</span></span>
<span><span class="co">#&gt; 20 -176.1602 62.07259 -0.007434424 0.003779935     92.31936      -0.02377643</span></span>
<span><span class="co">#&gt; 22 -176.0257 62.09423 -0.007299981 0.003801570     92.29796      -0.11071504</span></span>
<span><span class="co">#&gt;    EFFORT</span></span>
<span><span class="co">#&gt; 7       1</span></span>
<span><span class="co">#&gt; 11      1</span></span>
<span><span class="co">#&gt; 12      1</span></span>
<span><span class="co">#&gt; 18      1</span></span>
<span><span class="co">#&gt; 20      1</span></span>
<span><span class="co">#&gt; 22      1</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="a--covariate-data">5a. Covariate Data<a class="anchor" aria-label="anchor" href="#a--covariate-data"></a>
</h3>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">## split data by species, make into DATRASraw + Nage matrix</span></span>
<span><span class="va">ds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/split.html" class="external-link">split</a></span><span class="op">(</span><span class="va">dat_catch_haul</span>,<span class="va">dat_catch_haul</span><span class="op">$</span><span class="va">COMMON_NAME</span><span class="op">)</span></span>
<span><span class="va">ds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">ds</span>, <span class="fu">surveyIndex</span><span class="fu">::</span><span class="va"><a href="../reference/get_datrasraw.html">get_datrasraw</a></span><span class="op">)</span></span>
<span><span class="co">## OBS, response is added here in "Nage" matrix -- use wCPUE</span></span>
<span><span class="va">ds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">ds</span>,<span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span> <span class="va">x</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">Nage</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">wCPUE</span>,ncol<span class="op">=</span><span class="fl">1</span><span class="op">)</span>; <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">x</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">Nage</span><span class="op">)</span><span class="op">&lt;-</span><span class="fl">1</span>; <span class="va">x</span> <span class="op">}</span> <span class="op">)</span></span>
<span></span>
<span><span class="va">ds</span></span>
<span><span class="co">#&gt; $`red king crab`</span></span>
<span><span class="co">#&gt; Object of class 'DATRASraw'</span></span>
<span><span class="co">#&gt; ===========================</span></span>
<span><span class="co">#&gt; Number of hauls: 598 </span></span>
<span><span class="co">#&gt; Number of species: 0 </span></span>
<span><span class="co">#&gt; Number of countries: 0 </span></span>
<span><span class="co">#&gt; Years: 2015 2016 2017 2018 2019 2021 </span></span>
<span><span class="co">#&gt; Quarters: </span></span>
<span><span class="co">#&gt; Gears: </span></span>
<span><span class="co">#&gt; Haul duration: 0.266 - 0.609 minutes</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $`walleye pollock`</span></span>
<span><span class="co">#&gt; Object of class 'DATRASraw'</span></span>
<span><span class="co">#&gt; ===========================</span></span>
<span><span class="co">#&gt; Number of hauls: 2238 </span></span>
<span><span class="co">#&gt; Number of species: 0 </span></span>
<span><span class="co">#&gt; Number of countries: 0 </span></span>
<span><span class="co">#&gt; Years: 2015 2016 2017 2018 2019 2021 </span></span>
<span><span class="co">#&gt; Quarters: </span></span>
<span><span class="co">#&gt; Gears: </span></span>
<span><span class="co">#&gt; Haul duration: 0.206 - 0.609 minutes</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $`yellowfin sole`</span></span>
<span><span class="co">#&gt; Object of class 'DATRASraw'</span></span>
<span><span class="co">#&gt; ===========================</span></span>
<span><span class="co">#&gt; Number of hauls: 1497 </span></span>
<span><span class="co">#&gt; Number of species: 0 </span></span>
<span><span class="co">#&gt; Number of countries: 0 </span></span>
<span><span class="co">#&gt; Years: 2015 2016 2017 2018 2019 2021 </span></span>
<span><span class="co">#&gt; Quarters: </span></span>
<span><span class="co">#&gt; Gears: </span></span>
<span><span class="co">#&gt; Haul duration: 0.206 - 0.609 minutes</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="formulas">6. Formulas<a class="anchor" aria-label="anchor" href="#formulas"></a>
</h2>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fm</span> <span class="op">&lt;-</span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="co"># Null model spatial and temporal with an additional year effect</span></span>
<span>  <span class="st">"fm_1_s_t_st"</span> <span class="op">=</span> <span class="st">"Year +</span></span>
<span><span class="st">    s(sx,sy,bs=c('ts'),k=376) + </span></span>
<span><span class="st">    s(sx,sy,bs=c('ts'),k=10,by=Year)"</span>,</span>
<span>  </span>
<span>  <span class="co"># Mdoel with simple covariates</span></span>
<span>  <span class="st">"fm_2_cov"</span> <span class="op">=</span> </span>
<span>    <span class="st">"s(BOTTOM_DEPTH,bs='ts',k=10) +</span></span>
<span><span class="st">s(log(GEAR_TEMPERATURE+3),bs='ts',k=10)"</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="fit-the-model">7. Fit the Model<a class="anchor" aria-label="anchor" href="#fit-the-model"></a>
</h2>
<p>Here are all of the models we want to try fitting:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">comb</span> <span class="op">&lt;-</span> <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/expand.html" class="external-link">crossing</a></span><span class="op">(</span></span>
<span>  <span class="st">"SPECIES"</span> <span class="op">=</span> <span class="va">SPECIES</span>, </span>
<span>  <span class="st">"fm_name"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span>pattern <span class="op">=</span> <span class="st">" "</span>, replacement <span class="op">=</span> <span class="st">"_"</span>, x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">fm</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="va">.</span>, </span>
<span>    y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="st">"fm"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span>pattern <span class="op">=</span> <span class="st">"\n"</span>, replacement <span class="op">=</span> <span class="st">""</span>, </span>
<span>                               x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">fm</span><span class="op">)</span>, fixed <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, </span>
<span>                   <span class="st">"fm_name"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span>pattern <span class="op">=</span> <span class="st">" "</span>, replacement <span class="op">=</span> <span class="st">"_"</span>, </span>
<span>                                    x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">fm</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, </span>
<span>    by <span class="op">=</span> <span class="st">"fm_name"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">comb</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 3</span></span></span>
<span><span class="co">#&gt;   SPECIES         fm_name     fm                                                </span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>           <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                                             </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> red king crab   fm_1_s_t_st Year +    s(sx,sy,bs=c('ts'),k=376) +     s(sx,sy…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> red king crab   fm_2_cov    s(BOTTOM_DEPTH,bs='ts',k=10) +s(log(GEAR_TEMPERAT…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> walleye pollock fm_1_s_t_st Year +    s(sx,sy,bs=c('ts'),k=376) +     s(sx,sy…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> walleye pollock fm_2_cov    s(BOTTOM_DEPTH,bs='ts',k=10) +s(log(GEAR_TEMPERAT…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> yellowfin sole  fm_1_s_t_st Year +    s(sx,sy,bs=c('ts'),k=376) +     s(sx,sy…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> yellowfin sole  fm_2_cov    s(BOTTOM_DEPTH,bs='ts',k=10) +s(log(GEAR_TEMPERAT…</span></span></code></pre></div>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">models</span> <span class="op">&lt;-</span> <span class="va">fittimes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">comb</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Fitting "</span>,<span class="va">comb</span><span class="op">$</span><span class="va">SPECIES</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="st">"\n"</span>, <span class="va">comb</span><span class="op">$</span><span class="va">fm_name</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="st">": "</span>, <span class="va">comb</span><span class="op">$</span><span class="va">fm</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">temp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">comb</span><span class="op">$</span><span class="va">SPECIES</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="st">" "</span>, <span class="va">comb</span><span class="op">$</span><span class="va">fm_name</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">fittimes</span><span class="op">[[</span> <span class="va">temp</span> <span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span> <span class="op">(</span> <span class="va">models</span><span class="op">[[</span> <span class="va">temp</span> <span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span></span>
<span>                    <span class="fu">surveyIndex</span><span class="fu">::</span><span class="fu"><a href="../reference/get_surveyidx.html">get_surveyidx</a></span><span class="op">(</span></span>
<span>                      x <span class="op">=</span> <span class="va">ds</span><span class="op">[[</span> <span class="va">comb</span><span class="op">$</span><span class="va">SPECIES</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">]</span><span class="op">]</span>,</span>
<span>                      ages <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                      myids <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>                      predD <span class="op">=</span> <span class="va">allpd</span>,</span>
<span>                      cutOff <span class="op">=</span> <span class="fl">0</span>,</span>
<span>                      fam <span class="op">=</span> <span class="st">"Tweedie"</span>,</span>
<span>                      modelP <span class="op">=</span> <span class="va">comb</span><span class="op">$</span><span class="va">fm</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,</span>
<span>                      gamma <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                      control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>trace <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                                     maxit <span class="op">=</span> <span class="fl">20</span><span class="op">)</span><span class="op">)</span>  <span class="op">)</span></span>
<span>  </span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/save.html" class="external-link">save</a></span><span class="op">(</span><span class="va">models</span>, <span class="va">fittimes</span>, file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"../inst/VigA_model_fits.Rdata"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Check basis dimensions splines (spatial resolution)</span></span>
<span><span class="co"># sink(paste0(".", dir_out, "gamcheck.txt"))</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">models</span>,<span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/gam.check.html" class="external-link">gam.check</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">pModels</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="A-data-prep_files/figure-html/model_check1-1.png" width="700"></p>
<pre><code><span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Method: ML   Optimizer: outer newton</span></span>
<span><span class="co">#&gt; full convergence after 15 iterations.</span></span>
<span><span class="co">#&gt; Gradient range [-0.0006762137,9.344329e-05]</span></span>
<span><span class="co">#&gt; (score 1166.64 &amp; scale 0.7951414).</span></span>
<span><span class="co">#&gt; Hessian positive definite, eigenvalue range [1.138134e-05,373.6608].</span></span>
<span><span class="co">#&gt; Model rank =  435 / 435 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Basis dimension (k) checking results. Low p-value (k-index&lt;1) may</span></span>
<span><span class="co">#&gt; indicate that k is too low, especially if edf is close to k'.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;                         k'      edf k-index p-value</span></span>
<span><span class="co">#&gt; s(sx,sy)          3.75e+02 5.57e+01    1.02       1</span></span>
<span><span class="co">#&gt; s(sx,sy):Year2015 9.00e+00 1.89e+00    1.02       1</span></span>
<span><span class="co">#&gt; s(sx,sy):Year2016 9.00e+00 1.81e+00    1.02       1</span></span>
<span><span class="co">#&gt; s(sx,sy):Year2017 9.00e+00 1.09e+00    1.02       1</span></span>
<span><span class="co">#&gt; s(sx,sy):Year2018 9.00e+00 3.69e-05    1.02       1</span></span>
<span><span class="co">#&gt; s(sx,sy):Year2019 9.00e+00 3.57e-05    1.02       1</span></span>
<span><span class="co">#&gt; s(sx,sy):Year2021 9.00e+00 6.51e-01    1.02       1</span></span></code></pre>
<p><img src="A-data-prep_files/figure-html/model_check1-2.png" width="700"></p>
<pre><code><span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Method: ML   Optimizer: outer newton</span></span>
<span><span class="co">#&gt; full convergence after 14 iterations.</span></span>
<span><span class="co">#&gt; Gradient range [-0.0006031624,4.562128e-06]</span></span>
<span><span class="co">#&gt; (score 1282.403 &amp; scale 1.234582).</span></span>
<span><span class="co">#&gt; Hessian positive definite, eigenvalue range [0.0005522579,402.3254].</span></span>
<span><span class="co">#&gt; Model rank =  19 / 19 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Basis dimension (k) checking results. Low p-value (k-index&lt;1) may</span></span>
<span><span class="co">#&gt; indicate that k is too low, especially if edf is close to k'.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;                                 k'   edf k-index p-value    </span></span>
<span><span class="co">#&gt; s(BOTTOM_DEPTH)              9.000 4.388    0.76  &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; s(log(GEAR_TEMPERATURE + 3)) 9.000 0.944    0.77    0.01 ** </span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span></code></pre>
<p><img src="A-data-prep_files/figure-html/model_check1-3.png" width="700"></p>
<pre><code><span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Method: ML   Optimizer: outer newton</span></span>
<span><span class="co">#&gt; full convergence after 18 iterations.</span></span>
<span><span class="co">#&gt; Gradient range [-0.01277983,0.0005051565]</span></span>
<span><span class="co">#&gt; (score 11803.57 &amp; scale 1.204289).</span></span>
<span><span class="co">#&gt; Hessian positive definite, eigenvalue range [0.0003227355,1492.377].</span></span>
<span><span class="co">#&gt; Model rank =  435 / 435 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Basis dimension (k) checking results. Low p-value (k-index&lt;1) may</span></span>
<span><span class="co">#&gt; indicate that k is too low, especially if edf is close to k'.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;                         k'      edf k-index p-value</span></span>
<span><span class="co">#&gt; s(sx,sy)          3.75e+02 1.26e+02    0.87    0.11</span></span>
<span><span class="co">#&gt; s(sx,sy):Year2015 9.00e+00 6.23e+00    0.87    0.14</span></span>
<span><span class="co">#&gt; s(sx,sy):Year2016 9.00e+00 1.29e-02    0.87    0.16</span></span>
<span><span class="co">#&gt; s(sx,sy):Year2017 9.00e+00 1.94e+00    0.87    0.14</span></span>
<span><span class="co">#&gt; s(sx,sy):Year2018 9.00e+00 8.12e+00    0.87    0.13</span></span>
<span><span class="co">#&gt; s(sx,sy):Year2019 9.00e+00 2.01e+00    0.87    0.11</span></span>
<span><span class="co">#&gt; s(sx,sy):Year2021 9.00e+00 6.41e-03    0.87    0.17</span></span></code></pre>
<p><img src="A-data-prep_files/figure-html/model_check1-4.png" width="700"></p>
<pre><code><span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Method: ML   Optimizer: outer newton</span></span>
<span><span class="co">#&gt; full convergence after 16 iterations.</span></span>
<span><span class="co">#&gt; Gradient range [-0.02933839,3.957573e-05]</span></span>
<span><span class="co">#&gt; (score 12048.47 &amp; scale 1.565443).</span></span>
<span><span class="co">#&gt; Hessian positive definite, eigenvalue range [0.002046042,1566.539].</span></span>
<span><span class="co">#&gt; Model rank =  19 / 19 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Basis dimension (k) checking results. Low p-value (k-index&lt;1) may</span></span>
<span><span class="co">#&gt; indicate that k is too low, especially if edf is close to k'.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;                                k'  edf k-index p-value    </span></span>
<span><span class="co">#&gt; s(BOTTOM_DEPTH)              9.00 5.70    0.77  &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; s(log(GEAR_TEMPERATURE + 3)) 9.00 5.56    0.73  &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span></code></pre>
<p><img src="A-data-prep_files/figure-html/model_check1-5.png" width="700"></p>
<pre><code><span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Method: ML   Optimizer: outer newton</span></span>
<span><span class="co">#&gt; full convergence after 18 iterations.</span></span>
<span><span class="co">#&gt; Gradient range [-0.0001287914,0.0001470902]</span></span>
<span><span class="co">#&gt; (score 6877.784 &amp; scale 0.9312515).</span></span>
<span><span class="co">#&gt; eigenvalue range [-0.0001454451,1033.582].</span></span>
<span><span class="co">#&gt; Model rank =  435 / 435 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Basis dimension (k) checking results. Low p-value (k-index&lt;1) may</span></span>
<span><span class="co">#&gt; indicate that k is too low, especially if edf is close to k'.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;                         k'      edf k-index p-value</span></span>
<span><span class="co">#&gt; s(sx,sy)          3.75e+02 1.52e+02       1    0.99</span></span>
<span><span class="co">#&gt; s(sx,sy):Year2015 9.00e+00 1.80e+00       1    0.99</span></span>
<span><span class="co">#&gt; s(sx,sy):Year2016 9.00e+00 1.15e-03       1    1.00</span></span>
<span><span class="co">#&gt; s(sx,sy):Year2017 9.00e+00 2.08e-03       1    0.98</span></span>
<span><span class="co">#&gt; s(sx,sy):Year2018 9.00e+00 1.87e+00       1    0.99</span></span>
<span><span class="co">#&gt; s(sx,sy):Year2019 9.00e+00 6.64e+00       1    0.98</span></span>
<span><span class="co">#&gt; s(sx,sy):Year2021 9.00e+00 1.95e+00       1    0.99</span></span></code></pre>
<p><img src="A-data-prep_files/figure-html/model_check1-6.png" width="700"></p>
<pre><code><span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Method: ML   Optimizer: outer newton</span></span>
<span><span class="co">#&gt; full convergence after 7 iterations.</span></span>
<span><span class="co">#&gt; Gradient range [-0.004658969,-3.680354e-08]</span></span>
<span><span class="co">#&gt; (score 7295.94 &amp; scale 1.414592).</span></span>
<span><span class="co">#&gt; Hessian positive definite, eigenvalue range [2.581763,1062.083].</span></span>
<span><span class="co">#&gt; Model rank =  19 / 19 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Basis dimension (k) checking results. Low p-value (k-index&lt;1) may</span></span>
<span><span class="co">#&gt; indicate that k is too low, especially if edf is close to k'.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;                                k'  edf k-index p-value    </span></span>
<span><span class="co">#&gt; s(BOTTOM_DEPTH)              9.00 5.10    0.75  &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; s(log(GEAR_TEMPERATURE + 3)) 9.00 7.21    0.74  &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; $`red king crab fm_1_s_t_st`</span></span>
<span><span class="co">#&gt; $`red king crab fm_1_s_t_st`$mfrow</span></span>
<span><span class="co">#&gt; [1] 2 2</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $`red king crab fm_2_cov`</span></span>
<span><span class="co">#&gt; $`red king crab fm_2_cov`$mfrow</span></span>
<span><span class="co">#&gt; [1] 2 2</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $`walleye pollock fm_1_s_t_st`</span></span>
<span><span class="co">#&gt; $`walleye pollock fm_1_s_t_st`$mfrow</span></span>
<span><span class="co">#&gt; [1] 2 2</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $`walleye pollock fm_2_cov`</span></span>
<span><span class="co">#&gt; $`walleye pollock fm_2_cov`$mfrow</span></span>
<span><span class="co">#&gt; [1] 2 2</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $`yellowfin sole fm_1_s_t_st`</span></span>
<span><span class="co">#&gt; $`yellowfin sole fm_1_s_t_st`$mfrow</span></span>
<span><span class="co">#&gt; [1] 2 2</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $`yellowfin sole fm_2_cov`</span></span>
<span><span class="co">#&gt; $`yellowfin sole fm_2_cov`$mfrow</span></span>
<span><span class="co">#&gt; [1] 2 2</span></span>
<span><span class="co"># sink()</span></span></code></pre>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Model summaries</span></span>
<span><span class="co"># sink(paste0(".", dir_out, "summaries.txt"))</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">models</span>,<span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">pModels</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; $`red king crab fm_1_s_t_st`</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Family: Tweedie(p=1.99) </span></span>
<span><span class="co">#&gt; Link function: log </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Formula:</span></span>
<span><span class="co">#&gt; A1 ~ Year + s(sx, sy, bs = c("ts"), k = 376) + s(sx, sy, bs = c("ts"), </span></span>
<span><span class="co">#&gt;     k = 10, by = Year)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Parametric coefficients:</span></span>
<span><span class="co">#&gt;             Estimate Std. Error t value Pr(&gt;|t|)    </span></span>
<span><span class="co">#&gt; (Intercept)  1.08908    0.09111  11.953  &lt; 2e-16 ***</span></span>
<span><span class="co">#&gt; Year2016    -0.14646    0.13198  -1.110 0.267614    </span></span>
<span><span class="co">#&gt; Year2017    -0.16235    0.12839  -1.264 0.206611    </span></span>
<span><span class="co">#&gt; Year2018    -0.52665    0.13190  -3.993 7.45e-05 ***</span></span>
<span><span class="co">#&gt; Year2019    -0.48895    0.13310  -3.674 0.000263 ***</span></span>
<span><span class="co">#&gt; Year2021    -0.36676    0.12596  -2.912 0.003745 ** </span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Approximate significance of smooth terms:</span></span>
<span><span class="co">#&gt;                         edf Ref.df       F  p-value    </span></span>
<span><span class="co">#&gt; s(sx,sy)          5.574e+01     83 140.826   0.9598    </span></span>
<span><span class="co">#&gt; s(sx,sy):Year2015 1.891e+00      9   4.380  &lt; 2e-16 ***</span></span>
<span><span class="co">#&gt; s(sx,sy):Year2016 1.808e+00      9   2.075 1.86e-05 ***</span></span>
<span><span class="co">#&gt; s(sx,sy):Year2017 1.091e+00      9   0.343   0.0503 .  </span></span>
<span><span class="co">#&gt; s(sx,sy):Year2018 3.686e-05      9   0.000   0.8721    </span></span>
<span><span class="co">#&gt; s(sx,sy):Year2019 3.568e-05      9   0.000   0.8038    </span></span>
<span><span class="co">#&gt; s(sx,sy):Year2021 6.510e-01      9   0.106   0.2033    </span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; R-sq.(adj) =  0.192   Deviance explained = 57.6%</span></span>
<span><span class="co">#&gt; -ML = 1166.6  Scale est. = 0.79514   n = 598</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $`red king crab fm_2_cov`</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Family: Tweedie(p=1.99) </span></span>
<span><span class="co">#&gt; Link function: log </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Formula:</span></span>
<span><span class="co">#&gt; A1 ~ s(BOTTOM_DEPTH, bs = "ts", k = 10) + s(log(GEAR_TEMPERATURE + </span></span>
<span><span class="co">#&gt;     3), bs = "ts", k = 10)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Parametric coefficients:</span></span>
<span><span class="co">#&gt;             Estimate Std. Error t value Pr(&gt;|t|)    </span></span>
<span><span class="co">#&gt; (Intercept)  1.13463    0.04518   25.11   &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Approximate significance of smooth terms:</span></span>
<span><span class="co">#&gt;                                 edf Ref.df      F  p-value    </span></span>
<span><span class="co">#&gt; s(BOTTOM_DEPTH)              4.3876      9 29.532  &lt; 2e-16 ***</span></span>
<span><span class="co">#&gt; s(log(GEAR_TEMPERATURE + 3)) 0.9445      9  1.338 0.000324 ***</span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; R-sq.(adj) =  0.0652   Deviance explained = 24.7%</span></span>
<span><span class="co">#&gt; -ML = 1282.4  Scale est. = 1.2346    n = 598</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $`walleye pollock fm_1_s_t_st`</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Family: Tweedie(p=1.99) </span></span>
<span><span class="co">#&gt; Link function: log </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Formula:</span></span>
<span><span class="co">#&gt; A1 ~ Year + s(sx, sy, bs = c("ts"), k = 376) + s(sx, sy, bs = c("ts"), </span></span>
<span><span class="co">#&gt;     k = 10, by = Year)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Parametric coefficients:</span></span>
<span><span class="co">#&gt;             Estimate Std. Error t value Pr(&gt;|t|)    </span></span>
<span><span class="co">#&gt; (Intercept)  4.63282    0.05539  83.640  &lt; 2e-16 ***</span></span>
<span><span class="co">#&gt; Year2016    -0.36142    0.07851  -4.604 4.40e-06 ***</span></span>
<span><span class="co">#&gt; Year2017    -0.24860    0.07855  -3.165  0.00157 ** </span></span>
<span><span class="co">#&gt; Year2018    -0.84736    0.07879 -10.754  &lt; 2e-16 ***</span></span>
<span><span class="co">#&gt; Year2019    -0.45947    0.07847  -5.855 5.52e-09 ***</span></span>
<span><span class="co">#&gt; Year2021    -0.89127    0.07855 -11.346  &lt; 2e-16 ***</span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Approximate significance of smooth terms:</span></span>
<span><span class="co">#&gt;                         edf Ref.df      F p-value    </span></span>
<span><span class="co">#&gt; s(sx,sy)          1.256e+02    375  3.261  &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; s(sx,sy):Year2015 6.228e+00      9  4.137  &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; s(sx,sy):Year2016 1.289e-02      9  0.001   0.523    </span></span>
<span><span class="co">#&gt; s(sx,sy):Year2017 1.942e+00      9  8.969  &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; s(sx,sy):Year2018 8.125e+00      9 12.586  &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; s(sx,sy):Year2019 2.011e+00      9 10.858  &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; s(sx,sy):Year2021 6.411e-03      9  0.000   0.689    </span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; R-sq.(adj) =  0.0865   Deviance explained = 38.7%</span></span>
<span><span class="co">#&gt; -ML =  11804  Scale est. = 1.2043    n = 2238</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $`walleye pollock fm_2_cov`</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Family: Tweedie(p=1.99) </span></span>
<span><span class="co">#&gt; Link function: log </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Formula:</span></span>
<span><span class="co">#&gt; A1 ~ s(BOTTOM_DEPTH, bs = "ts", k = 10) + s(log(GEAR_TEMPERATURE + </span></span>
<span><span class="co">#&gt;     3), bs = "ts", k = 10)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Parametric coefficients:</span></span>
<span><span class="co">#&gt;             Estimate Std. Error t value Pr(&gt;|t|)    </span></span>
<span><span class="co">#&gt; (Intercept)  4.43599    0.02587   171.5   &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Approximate significance of smooth terms:</span></span>
<span><span class="co">#&gt;                                edf Ref.df      F p-value    </span></span>
<span><span class="co">#&gt; s(BOTTOM_DEPTH)              5.701      9 17.860  &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; s(log(GEAR_TEMPERATURE + 3)) 5.565      9  7.895  &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; R-sq.(adj) =  0.0476   Deviance explained =   13%</span></span>
<span><span class="co">#&gt; -ML =  12048  Scale est. = 1.5654    n = 2238</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $`yellowfin sole fm_1_s_t_st`</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Family: Tweedie(p=1.837) </span></span>
<span><span class="co">#&gt; Link function: log </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Formula:</span></span>
<span><span class="co">#&gt; A1 ~ Year + s(sx, sy, bs = c("ts"), k = 376) + s(sx, sy, bs = c("ts"), </span></span>
<span><span class="co">#&gt;     k = 10, by = Year)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Parametric coefficients:</span></span>
<span><span class="co">#&gt;             Estimate Std. Error t value Pr(&gt;|t|)    </span></span>
<span><span class="co">#&gt; (Intercept)  3.14125    0.05058  62.104  &lt; 2e-16 ***</span></span>
<span><span class="co">#&gt; Year2016     0.60736    0.06728   9.027  &lt; 2e-16 ***</span></span>
<span><span class="co">#&gt; Year2017     0.63183    0.06674   9.468  &lt; 2e-16 ***</span></span>
<span><span class="co">#&gt; Year2018     0.45639    0.06720   6.791 1.67e-11 ***</span></span>
<span><span class="co">#&gt; Year2019     0.49330    0.06728   7.333 3.91e-13 ***</span></span>
<span><span class="co">#&gt; Year2021    -0.07924    0.07000  -1.132    0.258    </span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Approximate significance of smooth terms:</span></span>
<span><span class="co">#&gt;                         edf Ref.df      F p-value    </span></span>
<span><span class="co">#&gt; s(sx,sy)          1.518e+02    375  8.597 &lt; 2e-16 ***</span></span>
<span><span class="co">#&gt; s(sx,sy):Year2015 1.796e+00      9  2.990 5.6e-07 ***</span></span>
<span><span class="co">#&gt; s(sx,sy):Year2016 1.148e-03      9  0.000   0.349    </span></span>
<span><span class="co">#&gt; s(sx,sy):Year2017 2.077e-03      9  0.000   0.309    </span></span>
<span><span class="co">#&gt; s(sx,sy):Year2018 1.875e+00      9  4.259 &lt; 2e-16 ***</span></span>
<span><span class="co">#&gt; s(sx,sy):Year2019 6.637e+00      9 16.814 &lt; 2e-16 ***</span></span>
<span><span class="co">#&gt; s(sx,sy):Year2021 1.951e+00      9  5.300 &lt; 2e-16 ***</span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; R-sq.(adj) =  0.363   Deviance explained = 70.8%</span></span>
<span><span class="co">#&gt; -ML = 6877.8  Scale est. = 0.93125   n = 1497</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $`yellowfin sole fm_2_cov`</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Family: Tweedie(p=1.907) </span></span>
<span><span class="co">#&gt; Link function: log </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Formula:</span></span>
<span><span class="co">#&gt; A1 ~ s(BOTTOM_DEPTH, bs = "ts", k = 10) + s(log(GEAR_TEMPERATURE + </span></span>
<span><span class="co">#&gt;     3), bs = "ts", k = 10)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Parametric coefficients:</span></span>
<span><span class="co">#&gt;             Estimate Std. Error t value Pr(&gt;|t|)    </span></span>
<span><span class="co">#&gt; (Intercept)  3.86352    0.02574   150.1   &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Approximate significance of smooth terms:</span></span>
<span><span class="co">#&gt;                                edf Ref.df     F p-value    </span></span>
<span><span class="co">#&gt; s(BOTTOM_DEPTH)              5.101      9 78.62  &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; s(log(GEAR_TEMPERATURE + 3)) 7.206      9 68.55  &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; R-sq.(adj) =  0.152   Deviance explained = 35.1%</span></span>
<span><span class="co">#&gt; -ML = 7295.9  Scale est. = 1.4146    n = 1497</span></span>
<span><span class="co"># sink()</span></span>
<span></span>
<span><span class="fu">surveyIndex</span><span class="fu">::</span><span class="fu"><a href="../reference/get_surveyidx_aic.html">get_surveyidx_aic</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">models</span><span class="op">)</span></span>
<span><span class="co">#&gt; numeric(0)</span></span></code></pre></div>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">temp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">models</span>, <span class="va">`[`</span>, <span class="st">"pModels"</span><span class="op">)</span></span>
<span><span class="va">mods</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">temp</span>, <span class="va">`[`</span>, <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">mods</span>, FUN <span class="op">=</span> <span class="va">AIC</span><span class="op">)</span></span>
<span><span class="co">#&gt; $`red king crab fm_1_s_t_st.pModels`</span></span>
<span><span class="co">#&gt; [1] 2296.156</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $`red king crab fm_2_cov.pModels`</span></span>
<span><span class="co">#&gt; [1] 2557.333</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $`walleye pollock fm_1_s_t_st.pModels`</span></span>
<span><span class="co">#&gt; [1] 23423.24</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $`walleye pollock fm_2_cov.pModels`</span></span>
<span><span class="co">#&gt; [1] 24073.77</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $`yellowfin sole fm_1_s_t_st.pModels`</span></span>
<span><span class="co">#&gt; [1] 13530.95</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $`yellowfin sole fm_2_cov.pModels`</span></span>
<span><span class="co">#&gt; [1] 14558.2</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="indicies-of-abundance">8. Indicies of Abundance<a class="anchor" aria-label="anchor" href="#indicies-of-abundance"></a>
</h2>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">models</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">temp</span> <span class="op">&lt;-</span> <span class="va">models</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="va">dat0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>idx <span class="op">=</span> <span class="va">temp</span><span class="op">$</span><span class="va">idx</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>, </span>
<span>                     lo <span class="op">=</span> <span class="va">temp</span><span class="op">$</span><span class="va">lo</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>, </span>
<span>                     up <span class="op">=</span> <span class="va">temp</span><span class="op">$</span><span class="va">up</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>,</span>
<span>                     Year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">temp</span><span class="op">$</span><span class="va">idx</span><span class="op">)</span>, </span>
<span>                     group <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">models</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, </span>
<span>                     formula <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"cpue_kgha ~ "</span>, </span>
<span>                                      <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">temp</span><span class="op">$</span><span class="va">pModels</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">formula</span><span class="op">)</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">dat</span>, <span class="va">dat0</span><span class="op">)</span> </span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">dat</span><span class="op">$</span><span class="va">facet_group</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span>X <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/strsplit.html" class="external-link">strsplit</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">dat</span><span class="op">$</span><span class="va">group</span>, split <span class="op">=</span> <span class="st">" fm"</span><span class="op">)</span>, <span class="va">`[`</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># dat$model &lt;- paste0(sapply(X = strsplit(x = dat$group, split = " fm"), `[`, 2))</span></span>
<span></span>
<span><span class="va">dat</span><span class="op">[</span><span class="va">dat</span><span class="op">$</span><span class="va">Year</span> <span class="op">==</span> <span class="fl">2020</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"idx"</span>, <span class="st">"up"</span>, <span class="st">"lo"</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span></span>
<span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">dat</span>, </span>
<span>                mapping <span class="op">=</span> <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">Year</span>, </span>
<span>                              y <span class="op">=</span> <span class="va">idx</span>, </span>
<span>                              group <span class="op">=</span> <span class="va">formula</span>, </span>
<span>                              color <span class="op">=</span> <span class="va">formula</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_line</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_point</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>  <span class="op">+</span> </span>
<span>  <span class="fu">geom_ribbon</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">lo</span>, ymax <span class="op">=</span> <span class="va">up</span>, fill <span class="op">=</span> <span class="va">formula</span><span class="op">)</span>, </span>
<span>              alpha<span class="op">=</span><span class="fl">0.1</span>, </span>
<span>              linetype<span class="op">=</span><span class="st">"dashed"</span>,</span>
<span>              color<span class="op">=</span><span class="st">"grey"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"Annual Index Model Results"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="fu">vars</span><span class="op">(</span><span class="va">facet_group</span><span class="op">)</span>, scales <span class="op">=</span> <span class="st">"free"</span>, ncol <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span>, </span>
<span>        legend.direction <span class="op">=</span> <span class="st">"vertical"</span><span class="op">)</span></span></code></pre></div>
<p><img src="A-data-prep_files/figure-html/indicie_abund-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="predict-and-plot">9. Predict and plot<a class="anchor" aria-label="anchor" href="#predict-and-plot"></a>
</h2>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">dat_pred</span> <span class="op">&lt;-</span> <span class="va">dat_catch_haul</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">Year</span>, <span class="va">sx</span>, <span class="va">sy</span>, <span class="va">Lon</span>, <span class="va">Lat</span>, <span class="va">GEAR_TEMPERATURE</span>, <span class="va">BOTTOM_DEPTH</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">models</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">temp</span> <span class="op">&lt;-</span> <span class="va">models</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="va">dat0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>idx <span class="op">=</span> </span>
<span>                 <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/predict.gam.html" class="external-link">predict.gam</a></span><span class="op">(</span></span>
<span>                   object <span class="op">=</span> <span class="va">temp</span><span class="op">$</span><span class="va">pModels</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>,</span>
<span>                   newdata <span class="op">=</span> <span class="va">dat_pred</span><span class="op">)</span>,  </span>
<span>                     group <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">models</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, </span>
<span>                     formula <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"cpue_kgha ~ "</span>, </span>
<span>                                      <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">temp</span><span class="op">$</span><span class="va">pModels</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">formula</span><span class="op">)</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>               <span class="op">)</span></span>
<span>  <span class="va">dat00</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html" class="external-link">bind_cols</a></span><span class="op">(</span><span class="va">dat0</span>, <span class="va">dat_pred</span><span class="op">)</span> </span>
<span>  <span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">dat</span>, <span class="va">dat00</span><span class="op">)</span> </span>
<span>  </span>
<span><span class="co"># dat_r &lt;- raster::rasterFromXYZ(xyz = dat00[,c("lon", "lat", "idx")])</span></span>
<span>    </span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">dat</span><span class="op">$</span><span class="va">facet_group</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span>X <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/strsplit.html" class="external-link">strsplit</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">dat</span><span class="op">$</span><span class="va">group</span>, split <span class="op">=</span> <span class="st">" fm"</span><span class="op">)</span>, <span class="va">`[`</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">facet_group</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  </span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">dat</span> <span class="op">%&gt;%</span> </span>
<span>                  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">facet_group</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">facet_group</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span>, </span>
<span>                mapping <span class="op">=</span> <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">Lon</span>, </span>
<span>                              y <span class="op">=</span> <span class="va">Lat</span>, </span>
<span>                              group <span class="op">=</span> <span class="va">group</span>, </span>
<span>                              color <span class="op">=</span> <span class="va">idx</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span><span class="op">)</span>  <span class="op">+</span> </span>
<span>  <span class="fu">ggtitle</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Annual Index Model Results for "</span>, <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">facet_group</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_grid</span><span class="op">(</span>cols <span class="op">=</span> <span class="fu">vars</span><span class="op">(</span><span class="va">group</span><span class="op">)</span>, </span>
<span>             rows <span class="op">=</span> <span class="fu">vars</span><span class="op">(</span><span class="va">Year</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span></span>
<span>  </span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="simulations">10. Simulations<a class="anchor" aria-label="anchor" href="#simulations"></a>
</h2>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">sims</span> <span class="op">&lt;-</span> <span class="va">fittimes_sims</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">comb</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Simulating "</span>,<span class="va">comb</span><span class="op">$</span><span class="va">SPECIES</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="st">"\n"</span>, <span class="va">comb</span><span class="op">$</span><span class="va">fm_name</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="st">": "</span>, <span class="va">comb</span><span class="op">$</span><span class="va">fm</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">temp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">comb</span><span class="op">$</span><span class="va">SPECIES</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="st">" "</span>, <span class="va">comb</span><span class="op">$</span><span class="va">fm_name</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">fittimes</span><span class="op">[[</span> <span class="va">temp</span> <span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span> <span class="op">(</span> <span class="va">sims</span><span class="op">[[</span> <span class="va">temp</span> <span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span></span>
<span>                    <span class="fu">surveyIndex</span><span class="fu">::</span><span class="fu"><a href="../reference/get_surveyidx_sim.html">get_surveyidx_sim</a></span><span class="op">(</span></span>
<span>                      model <span class="op">=</span> <span class="va">models</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>, </span>
<span>                      d <span class="op">=</span> <span class="va">ds</span><span class="op">[[</span> <span class="va">comb</span><span class="op">$</span><span class="va">SPECIES</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">]</span><span class="op">]</span><span class="op">)</span> <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; Simulating  red king crab </span></span>
<span><span class="co">#&gt;  fm_1_s_t_st :  Year +    s(sx,sy,bs=c('ts'),k=376) +     s(sx,sy,bs=c('ts'),k=10,by=Year) </span></span>
<span><span class="co">#&gt; Simulating  red king crab </span></span>
<span><span class="co">#&gt;  fm_2_cov :  s(BOTTOM_DEPTH,bs='ts',k=10) +s(log(GEAR_TEMPERATURE+3),bs='ts',k=10) </span></span>
<span><span class="co">#&gt; Simulating  walleye pollock </span></span>
<span><span class="co">#&gt;  fm_1_s_t_st :  Year +    s(sx,sy,bs=c('ts'),k=376) +     s(sx,sy,bs=c('ts'),k=10,by=Year) </span></span>
<span><span class="co">#&gt; Simulating  walleye pollock </span></span>
<span><span class="co">#&gt;  fm_2_cov :  s(BOTTOM_DEPTH,bs='ts',k=10) +s(log(GEAR_TEMPERATURE+3),bs='ts',k=10) </span></span>
<span><span class="co">#&gt; Simulating  yellowfin sole </span></span>
<span><span class="co">#&gt;  fm_1_s_t_st :  Year +    s(sx,sy,bs=c('ts'),k=376) +     s(sx,sy,bs=c('ts'),k=10,by=Year) </span></span>
<span><span class="co">#&gt; Simulating  yellowfin sole </span></span>
<span><span class="co">#&gt;  fm_2_cov :  s(BOTTOM_DEPTH,bs='ts',k=10) +s(log(GEAR_TEMPERATURE+3),bs='ts',k=10)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="co"># Create a 2 x 2 plotting matrix</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">comb</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">sims</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">sim</span>, main <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">sims</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="st">" sims"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">sims</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">mu</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, main <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">sims</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="st">" mu"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><img src="A-data-prep_files/figure-html/sim_gam-1.png" width="700"><img src="A-data-prep_files/figure-html/sim_gam-2.png" width="700"><img src="A-data-prep_files/figure-html/sim_gam-3.png" width="700"></p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Emily Markowitz, Margaret Siple, Casper Berg.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.9000.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
