<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="How simple gams work and how they compare with surveyidx GAMs">
<title>Intro to GAMs • sdmgamindex</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Intro to GAMs">
<meta property="og:description" content="How simple gams work and how they compare with surveyidx GAMs">
<meta property="og:image" content="https://github.com/noaa-afsc/sdmgamindex/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">sdmgamindex</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.1</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Functions</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-vignettes">Vignettes</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-vignettes">
    <a class="dropdown-item" href="../articles/A-gam-basics.html">Intro to GAMs</a>
    <a class="dropdown-item" href="../articles/B_gam_sdmTMB_example.html">Fitting a spatiotemporal model and deriving an abundance index</a>
    <a class="dropdown-item" href="../articles/C-model-comparisons.html">Compare {sdmgamindex} to regular GAMs</a>
    <a class="dropdown-item" href="../articles/D-simple-case-study.html">sdmgamindex case study with and without covariates</a>
  </div>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/A-gam-basics.html">Intro to GAMs</a>
    <a class="dropdown-item" href="../articles/B-gam-sdmTMB-example.html">Fitting a spatiotemporal model and deriving an abundance index</a>
    <a class="dropdown-item" href="../articles/C-model-comparisons.html">Compare {sdmgamindex} to regular GAMs</a>
    <a class="dropdown-item" href="../articles/D-simple-case-study.html">{sdmgamindex} case study with and without covariates</a>
  </div>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-release-notes">Release Notes</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-release-notes">
    <a class="dropdown-item" href="https://github.com/noaa-afsc/sdmgamindex/releases/tag/2022.09.26">v 2022.09.26</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Intro to GAMs</h1>
            
            <h4 data-toc-skip class="date">March 11 2024</h4>
      
      
      <div class="d-none name"><code>A-gam-basics.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="example-set-up-and-context">Example set up and context:<a class="anchor" aria-label="anchor" href="#example-set-up-and-context"></a>
</h2>
<p>For this example, let’s say we want to assess:</p>
<p>In this example, we will use data from NOAA Fisheries’ eastern Bering
sea (EBS) bottom trawl survey. The Resource Assessment and Conservation
Engineering (RACE) Division Groundfish Assessment Program (GAP) of the
Alaska Fisheries Science Center (AFSC) conducts fisheries-independent
bottom trawl surveys to assess the populations of demersal fish and crab
stocks of Alaska. Data presented here are presence-only (non-zero)
observations from those surveys and therefore CANNOT be aggregated.</p>
<p>For the sake of a simple example, we will only assess data from 2015
to 2021.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">SPECIES</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"walleye pollock"</span><span class="op">)</span></span>
<span><span class="va">YEARS</span> <span class="op">&lt;-</span> <span class="fl">2015</span><span class="op">:</span><span class="fl">2021</span></span>
<span><span class="va">SRVY</span> <span class="op">&lt;-</span> <span class="st">"EBS"</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="what-data-area-we-using">1. What data area we using?<a class="anchor" aria-label="anchor" href="#what-data-area-we-using"></a>
</h2>
<p>Here, we use the public facing data from the <a href="https://www.fisheries.noaa.gov/foss" class="external-link">NOAA AFSC groundfish Bering
sea bottom trawl survey</a>. For more information about how these data
were compiled, see <a href="https://afsc-gap-products.github.io/gap_products/content/foss-intro.html" class="external-link">afsc-gap-products
GitHub repo</a>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu">sdmgamindex</span><span class="fu">::</span><span class="va"><a href="../reference/noaa_afsc_public_foss.html">noaa_afsc_public_foss</a></span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">srvy</span> <span class="op">==</span> <span class="va">SRVY</span> <span class="op">&amp;</span></span>
<span>                  <span class="va">year</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">YEARS</span> <span class="op">&amp;</span></span>
<span>                  <span class="va">common_name</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">SPECIES</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>hauljoin <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">stratum</span>, <span class="st">"_"</span>, <span class="va">station</span>, <span class="st">"_"</span>, <span class="va">date_time</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span></span>
<span>    <span class="va">year</span>, <span class="va">date_time</span>, <span class="va">latitude_dd</span>, <span class="va">longitude_dd</span>, <span class="co"># spatiotemproal data</span></span>
<span>    <span class="va">cpue_kgha</span>, <span class="va">common_name</span>, <span class="co"># catch data</span></span>
<span>    <span class="va">bottom_temperature_c</span>, <span class="va">depth_m</span>, <span class="co"># possible covariate data</span></span>
<span>    <span class="va">srvy</span>, <span class="va">area_swept_ha</span>, <span class="va">duration_hr</span>, <span class="va">vessel_id</span>, <span class="va">hauljoin</span> <span class="co"># haul/effort data)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="prepare-the-data-for-sdmgamindexget_surveyidx">2. Prepare the data for sdmgamindex::get_surveyidx():<a class="anchor" aria-label="anchor" href="#prepare-the-data-for-sdmgamindexget_surveyidx"></a>
</h2>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># project spatial data</span></span>
<span><span class="va">crs_proj</span> <span class="op">&lt;-</span> <span class="st">"EPSG:3338"</span> <span class="co"># NAD83 / Alaska Albers</span></span>
<span><span class="va">crs_latlon</span> <span class="op">&lt;-</span> <span class="st">"+proj=longlat +datum=WGS84"</span> <span class="co"># decimal degrees</span></span>
<span></span>
<span><span class="va">ll</span> <span class="op">&lt;-</span> <span class="fu">sdmgamindex</span><span class="fu">::</span><span class="fu"><a href="../reference/convert_crs.html">convert_crs</a></span><span class="op">(</span> </span>
<span>  x <span class="op">=</span> <span class="va">dat</span><span class="op">$</span><span class="va">longitude_dd</span>,</span>
<span>  y <span class="op">=</span> <span class="va">dat</span><span class="op">$</span><span class="va">latitude_dd</span>, </span>
<span>  crs_in <span class="op">=</span> <span class="va">crs_latlon</span>, </span>
<span>  crs_out <span class="op">=</span> <span class="va">crs_proj</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">YEARS</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">year</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># The sdmgamindex::get_surveyidx() expects some columns to be named in a specific way</span></span>
<span><span class="va">dat_wrangled</span> <span class="op">&lt;-</span> <span class="va">dat</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span></span>
<span>    Year <span class="op">=</span> <span class="va">year</span>,</span>
<span>    wCPUE <span class="op">=</span> <span class="va">cpue_kgha</span>, </span>
<span>    COMMON_NAME <span class="op">=</span> <span class="va">common_name</span>,</span>
<span>    GEAR_TEMPERATURE <span class="op">=</span> <span class="va">bottom_temperature_c</span>, </span>
<span>    BOTTOM_DEPTH <span class="op">=</span> <span class="va">depth_m</span>,</span>
<span>    HaulDur <span class="op">=</span> <span class="va">duration_hr</span>,</span>
<span>    EFFORT <span class="op">=</span> <span class="va">area_swept_ha</span>,</span>
<span>    Ship <span class="op">=</span> <span class="va">vessel_id</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span> </span>
<span>    <span class="co"># create some other vars</span></span>
<span>    Lon <span class="op">=</span> <span class="va">longitude_dd</span>, </span>
<span>    Lat <span class="op">=</span> <span class="va">latitude_dd</span>, </span>
<span>    lon <span class="op">=</span> <span class="va">ll</span><span class="op">$</span><span class="va">X</span>,</span>
<span>    lat <span class="op">=</span> <span class="va">ll</span><span class="op">$</span><span class="va">Y</span>,</span>
<span>    sx <span class="op">=</span> <span class="op">(</span><span class="op">(</span><span class="va">longitude_dd</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">longitude_dd</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="fl">1000</span><span class="op">)</span>,</span>
<span>    sy <span class="op">=</span> <span class="op">(</span><span class="op">(</span><span class="va">latitude_dd</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">latitude_dd</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="fl">1000</span><span class="op">)</span>, </span>
<span>    ctime <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">Year</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    date_time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">date_time</span>, format <span class="op">=</span> <span class="st">"%m/%d/%Y %H:%M:%S"</span><span class="op">)</span>, </span>
<span>    hour <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="va">date_time</span>,<span class="st">"%H"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    minute <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="va">date_time</span>,<span class="st">"%M"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    day <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="va">date_time</span>,<span class="st">"%d"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    month <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="va">date_time</span>,<span class="st">"%m"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    TimeShotHour <span class="op">=</span> <span class="va">hour</span> <span class="op">+</span> <span class="va">minute</span><span class="op">/</span><span class="fl">60</span>,</span>
<span>    timeOfYear <span class="op">=</span> <span class="op">(</span><span class="va">month</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="fl">1</span><span class="op">/</span><span class="fl">12</span> <span class="op">+</span> <span class="op">(</span><span class="va">day</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span><span class="op">/</span><span class="fl">365</span>,   </span>
<span>    </span>
<span>    <span class="co"># add some dummy vars and create some other vars</span></span>
<span>    Country <span class="op">=</span> <span class="st">"USA"</span>,</span>
<span>    Gear <span class="op">=</span> <span class="st">"dummy"</span>,</span>
<span>    Quarter <span class="op">=</span> <span class="st">"2"</span><span class="op">)</span>  <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span><span class="fu">across</span><span class="op">(</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Year"</span>, <span class="st">"Ship"</span>, <span class="st">"COMMON_NAME"</span><span class="op">)</span><span class="op">)</span>, <span class="va">as.factor</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">wCPUE</span>, <span class="va">GEAR_TEMPERATURE</span>, <span class="va">BOTTOM_DEPTH</span>, <span class="va">COMMON_NAME</span>, <span class="va">EFFORT</span>, </span>
<span>                <span class="va">Year</span>, <span class="va">Ship</span>, <span class="va">Lon</span>, <span class="va">Lat</span>, <span class="va">lat</span>, <span class="va">lon</span>, <span class="va">sx</span>, <span class="va">sy</span>, </span>
<span>                <span class="va">ctime</span>, <span class="va">TimeShotHour</span>, <span class="va">timeOfYear</span>, <span class="va">Gear</span>, <span class="va">Quarter</span>, <span class="va">HaulDur</span>, <span class="va">hauljoin</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">dat_wrangled</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="define-representitive-station-points-to-fit-and-predict-the-model-at">3. Define representitive station points to fit and predict the model
at<a class="anchor" aria-label="anchor" href="#define-representitive-station-points-to-fit-and-predict-the-model-at"></a>
</h2>
<p>Since surveys are not done at the same <em>exact</em> location each
year (it’s the intention, but impossible in practice), we need to define
what representative latitudes and longitudes we are going to predict
at.</p>
<p>These are the same prediction grids AFSC uses for their 2021 <a href="https://github.com/James-Thorson-NOAA/VAST" class="external-link">VAST model-based
indices</a> (which is subject to change - do not use this without
asking/checking that this is still current!).</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pred_grid</span> <span class="op">&lt;-</span> <span class="fu">sdmgamindex</span><span class="fu">::</span><span class="va"><a href="../reference/pred_grid_ebs.html">pred_grid_ebs</a></span></span>
<span></span>
<span><span class="va">ll</span> <span class="op">&lt;-</span> <span class="fu">sdmgamindex</span><span class="fu">::</span><span class="fu"><a href="../reference/convert_crs.html">convert_crs</a></span><span class="op">(</span> </span>
<span>  x <span class="op">=</span> <span class="va">pred_grid</span><span class="op">$</span><span class="va">lon</span>,</span>
<span>  y <span class="op">=</span> <span class="va">pred_grid</span><span class="op">$</span><span class="va">lat</span>, </span>
<span>  crs_in <span class="op">=</span> <span class="va">crs_latlon</span>, </span>
<span>  crs_out <span class="op">=</span> <span class="va">crs_proj</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">pred_grid</span> <span class="op">&lt;-</span> <span class="va">pred_grid</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span> </span>
<span>    lon <span class="op">=</span> <span class="va">ll</span><span class="op">$</span><span class="va">X</span>,</span>
<span>    lat <span class="op">=</span> <span class="va">ll</span><span class="op">$</span><span class="va">Y</span>,</span>
<span>    sx <span class="op">=</span> <span class="op">(</span><span class="op">(</span><span class="va">lon</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">lon</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="fl">1000</span><span class="op">)</span>,</span>
<span>    sy <span class="op">=</span> <span class="op">(</span><span class="op">(</span><span class="va">lat</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">lat</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="fl">1000</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">pred_grid</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="prepare-covariate-data">4. Prepare covariate data<a class="anchor" aria-label="anchor" href="#prepare-covariate-data"></a>
</h2>
<p>Here we want to match covariate data to the prediction grid.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">dat_cov</span> <span class="op">&lt;-</span> <span class="fu">sdmgamindex</span><span class="fu">::</span><span class="va"><a href="../reference/pred_grid_ebs.html">pred_grid_ebs</a></span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">Shape_Area</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span> </span>
<span>    sx <span class="op">=</span> <span class="op">(</span><span class="op">(</span><span class="va">lon</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">lon</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="fl">1000</span><span class="op">)</span>,</span>
<span>    sy <span class="op">=</span> <span class="op">(</span><span class="op">(</span><span class="va">lat</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">lat</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="fl">1000</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">sp_extrap_raster</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sp/man/SpatialPoints.html" class="external-link">SpatialPoints</a></span><span class="op">(</span></span>
<span>  coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/sp/man/coordinates.html" class="external-link">coordinates</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">dat_cov</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"lon"</span>, <span class="st">"lat"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>, </span>
<span>  proj4string <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/sp/man/CRS-class.html" class="external-link">CRS</a></span><span class="op">(</span><span class="va">crs_latlon</span><span class="op">)</span> <span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="a--data-that-varies-over-only-space-depth">4a. Data that varies over only space (depth)<a class="anchor" aria-label="anchor" href="#a--data-that-varies-over-only-space-depth"></a>
</h3>
<p>Here in the Bering sea, the depth rarely changes. The modeler may
consider making this variable time-varying as well if they are say, in
the Gulf of Alaska or the Aleutian Islands where currents and island
formation can markedly change depth.</p>
<p>For this, we are going to create a raster of depth in the Bering sea
from the survey data so we can merge that into the dataset at the
prediction grid lat/lons.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="va">dat_wrangled</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">Lon</span>, <span class="va">Lat</span>, <span class="va">BOTTOM_DEPTH</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/na.fail.html" class="external-link">na.omit</a></span><span class="op">(</span><span class="op">)</span>  <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">.</span>, </span>
<span>               coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Lon"</span>, y <span class="op">=</span> <span class="st">"Lat"</span><span class="op">)</span>, </span>
<span>               crs <span class="op">=</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html" class="external-link">st_crs</a></span><span class="op">(</span><span class="va">crs_latlon</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">idw_fit</span> <span class="op">&lt;-</span> <span class="fu">gstat</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/gstat/man/gstat.html" class="external-link">gstat</a></span><span class="op">(</span>formula <span class="op">=</span> <span class="va">BOTTOM_DEPTH</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>                        locations <span class="op">=</span> <span class="va">x</span>,</span>
<span>                        nmax <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># stn_predict &lt;- raster::predict(idw_fit, x)</span></span>
<span></span>
<span><span class="va">extrap_data0</span> <span class="op">&lt;-</span> <span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span></span>
<span>  <span class="va">idw_fit</span>, <span class="va">sp_extrap_raster</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="co"># as(sp_extrap_raster, Class = "SpatialPoints")) %&gt;%</span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span>crs <span class="op">=</span> <span class="va">crs_latlon</span><span class="op">)</span>  <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">stars</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_rasterize.html" class="external-link">st_rasterize</a></span><span class="op">(</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">extrap_data</span> <span class="op">&lt;-</span> <span class="fu">stars</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_extract.html" class="external-link">st_extract</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">extrap_data0</span>,</span>
<span>                                 at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">dat_cov</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"lon"</span>, <span class="st">"lat"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># to make future runs of this faster:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/save.html" class="external-link">save</a></span><span class="op">(</span><span class="va">extrap_data0</span>, <span class="va">extrap_data</span>, </span>
<span>     file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"../inst/VigA_bottom_depth_raster_"</span>,</span>
<span>                   <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">YEARS</span><span class="op">)</span>,<span class="st">"-"</span>,<span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">YEARS</span><span class="op">)</span>, <span class="st">".rdata"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Just so we can see what we are looking at:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">extrap_data0</span>, main <span class="op">=</span> <span class="st">"Interpolated Bottom Depths"</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">dat_cov</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind.data.frame</a></span><span class="op">(</span><span class="va">dat_cov</span>, </span>
<span>                            <span class="st">"BOTTOM_DEPTH"</span> <span class="op">=</span> <span class="va">extrap_data</span><span class="op">$</span><span class="va">var1.pred</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/na.fail.html" class="external-link">na.omit</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">dat_cov</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="b--data-that-varies-over-space-and-time-bottom-temperature">4b. Data that varies over space and time (bottom temperature)<a class="anchor" aria-label="anchor" href="#b--data-that-varies-over-space-and-time-bottom-temperature"></a>
</h3>
<p>Here, bottom temperature, and thereby the cold pool extent, have been
show to drive the distribution of many species. This is especially true
for walleye pollock.</p>
<p>For this we are going to lean on our in-house prepared validated and
pre-prepared <a href="https://github.com/afsc-gap-products/coldpool" class="external-link">{coldpool} R
package</a> (S. Rohan, L. Barnett, and N. Charriere). This data
interpolates over the whole area of the survey so there are no missing
data.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu">coldpool</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/coldpool/man/ebs_bottom_temperature.html" class="external-link">ebs_bottom_temperature</a></span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span> <span class="co"># Just so we can see what we are looking at: </span></span>
<span></span>
<span><span class="va">tmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">YEARS</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">tmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">tmp</span>, </span>
<span>           <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span>pattern <span class="op">=</span> <span class="va">YEARS</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="fu">coldpool</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/coldpool/man/ebs_bottom_temperature.html" class="external-link">ebs_bottom_temperature</a></span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">extrap_data0</span> <span class="op">&lt;-</span> <span class="fu">coldpool</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/coldpool/man/ebs_bottom_temperature.html" class="external-link">ebs_bottom_temperature</a></span><span class="op">[[</span><span class="va">tmp</span><span class="op">]</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu">as</span><span class="op">(</span><span class="va">.</span>, Class <span class="op">=</span> <span class="st">"SpatialPointsDataFrame"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span>crs <span class="op">=</span> <span class="va">crs_latlon</span><span class="op">)</span>  <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">stars</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_rasterize.html" class="external-link">st_rasterize</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu">stars</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_extract.html" class="external-link">st_extract</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">.</span>,</span>
<span>                    at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">dat_cov</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"lon"</span>, <span class="st">"lat"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">extrap_data0</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"GEAR_TEMPERATURE"</span>, <span class="va">YEARS</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dat_cov</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_cols.html" class="external-link">bind_cols</a></span><span class="op">(</span><span class="va">dat_cov</span>, <span class="va">extrap_data0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/na.fail.html" class="external-link">na.omit</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">dat_cov</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="datras-structure">5. DATRAS structure<a class="anchor" aria-label="anchor" href="#datras-structure"></a>
</h2>
<div class="section level3">
<h3 id="a--catch-data">5a. Catch Data<a class="anchor" aria-label="anchor" href="#a--catch-data"></a>
</h3>
<p>Now, we need to fill in the data with the zeros!</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Identify vars that will be used --------------------------------------------</span></span>
<span></span>
<span><span class="va">varsbyyr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span> <span class="co"># c("GEAR_TEMPERATURE", "cpi")</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span>pattern <span class="op">=</span> <span class="st">"[0-9]+"</span>, </span>
<span>       replacement <span class="op">=</span> <span class="st">""</span>, </span>
<span>       x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">dat_cov</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">dat_cov</span><span class="op">)</span>, </span>
<span>                                pattern <span class="op">=</span> <span class="st">"[0-9]+"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">vars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span> <span class="co"># c("BOTTOM_DEPTH")</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">dat_cov</span><span class="op">)</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">dat_cov</span><span class="op">)</span>, </span>
<span>                        pattern <span class="op">=</span> <span class="st">"[0-9]+"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">vars</span> <span class="op">&lt;-</span> <span class="va">vars</span><span class="op">[</span><span class="op">!</span><span class="op">(</span><span class="va">vars</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"LONG"</span>, <span class="st">"LAT"</span>, <span class="st">"lon"</span>, <span class="st">"lat"</span>, <span class="st">"sx"</span>, <span class="st">"sy"</span><span class="op">)</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co">## Fill catch data with zeros ---------------------------------------------------------</span></span>
<span></span>
<span><span class="va">data_hauls</span> <span class="op">&lt;-</span> <span class="va">dat_wrangled</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">Year</span>, <span class="va">sx</span>, <span class="va">sy</span>, </span>
<span>                <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/all_of.html" class="external-link">all_of</a></span><span class="op">(</span><span class="va">varsbyyr</span><span class="op">)</span>, <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/all_of.html" class="external-link">all_of</a></span><span class="op">(</span><span class="va">vars</span><span class="op">)</span>, </span>
<span>                <span class="va">Ship</span>, <span class="va">hauljoin</span>, </span>
<span>                <span class="va">lat</span>, <span class="va">lon</span>, <span class="va">Lat</span>, <span class="va">Lon</span>, </span>
<span>                <span class="va">ctime</span>, <span class="va">TimeShotHour</span>, <span class="va">timeOfYear</span>, <span class="va">Gear</span>, <span class="va">Quarter</span>, </span>
<span>                <span class="va">EFFORT</span>, <span class="va">HaulDur</span><span class="op">)</span>  <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="co"># dplyr::filter(!is.na(GEAR_TEMPERATURE)) %&gt;% </span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/na.fail.html" class="external-link">na.omit</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">data_catch</span> <span class="op">&lt;-</span> <span class="va">dat_wrangled</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">COMMON_NAME</span>, <span class="va">wCPUE</span>, <span class="va">hauljoin</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dat_catch_haul</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">data_hauls</span>, </span>
<span>                                   y <span class="op">=</span> <span class="va">data_catch</span>, </span>
<span>                                   by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hauljoin"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>wCPUE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">wCPUE</span><span class="op">)</span>, <span class="fl">0</span>, <span class="va">wCPUE</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">dat_catch_haul</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">allpd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">YEARS</span>, FUN <span class="op">=</span> <span class="fu">sdmgamindex</span><span class="fu">::</span><span class="va"><a href="../reference/get_prediction_grid.html">get_prediction_grid</a></span>, x <span class="op">=</span> <span class="va">dat_cov</span>, </span>
<span>                vars <span class="op">=</span> <span class="va">vars</span>, varsbyyr <span class="op">=</span> <span class="va">varsbyyr</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">allpd</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">YEARS</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">allpd</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="b--covariate-data">5b. Covariate Data<a class="anchor" aria-label="anchor" href="#b--covariate-data"></a>
</h3>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">## split data by species, make into DATRASraw + Nage matrix</span></span>
<span><span class="va">ds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/split.html" class="external-link">split</a></span><span class="op">(</span><span class="va">dat_catch_haul</span>,<span class="va">dat_catch_haul</span><span class="op">$</span><span class="va">COMMON_NAME</span><span class="op">)</span></span>
<span><span class="va">ds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">ds</span>, <span class="fu">sdmgamindex</span><span class="fu">::</span><span class="va"><a href="../reference/get_datrasraw.html">get_datrasraw</a></span><span class="op">)</span></span>
<span><span class="co">## OBS, response is added here in "Nage" matrix -- use wCPUE</span></span>
<span><span class="va">ds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">ds</span>,<span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span> <span class="va">x</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">Nage</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">wCPUE</span>,ncol<span class="op">=</span><span class="fl">1</span><span class="op">)</span>; <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">x</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">Nage</span><span class="op">)</span><span class="op">&lt;-</span><span class="fl">1</span>; <span class="va">x</span> <span class="op">}</span> <span class="op">)</span></span>
<span></span>
<span><span class="va">ds</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="formulas">6. Formulas<a class="anchor" aria-label="anchor" href="#formulas"></a>
</h2>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fm</span> <span class="op">&lt;-</span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="co"># Null model spatial and temporal with an additional year effect</span></span>
<span>    <span class="st">"fm_0_s"</span> <span class="op">=</span> <span class="st">"Year +</span></span>
<span><span class="st">    s(sx,sy,bs=c('ts'),k=376)"</span>,</span>
<span>    </span>
<span>      <span class="st">"fm_0_s"</span> <span class="op">=</span> <span class="st">"Year +</span></span>
<span><span class="st">    s(Year,bs=c('ts'),k=10)"</span>,</span>
<span>    </span>
<span>      <span class="st">"fm_0_st"</span> <span class="op">=</span> <span class="st">"Year +</span></span>
<span><span class="st">    s(sx,sy,bs=c('ts'),k=10,by=Year)"</span>,</span>
<span>  </span>
<span>  <span class="st">"fm_1_s_t_st"</span> <span class="op">=</span> <span class="st">"Year +</span></span>
<span><span class="st">    s(sx,sy,bs=c('ts'),k=376) +</span></span>
<span><span class="st">    s(sx,sy,bs=c('ts'),k=10,by=Year)"</span>,</span>
<span></span>
<span>  <span class="co"># Model with simple covariates</span></span>
<span>  <span class="st">"fm_2_cov"</span> <span class="op">=</span></span>
<span>    <span class="st">"s(BOTTOM_DEPTH,bs='ts',k=10) +</span></span>
<span><span class="st">s(log(GEAR_TEMPERATURE+3),bs='ts',k=10)"</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="fit-the-model">7. Fit the Model<a class="anchor" aria-label="anchor" href="#fit-the-model"></a>
</h2>
<p>Here are all of the models we want to try fitting:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">comb</span> <span class="op">&lt;-</span> <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/expand.html" class="external-link">crossing</a></span><span class="op">(</span></span>
<span>  <span class="st">"SPECIES"</span> <span class="op">=</span> <span class="va">SPECIES</span>, </span>
<span>  <span class="st">"fm_name"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span>pattern <span class="op">=</span> <span class="st">" "</span>, replacement <span class="op">=</span> <span class="st">"_"</span>, x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">fm</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="va">.</span>, </span>
<span>    y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="st">"fm"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span>pattern <span class="op">=</span> <span class="st">"\n"</span>, replacement <span class="op">=</span> <span class="st">""</span>, </span>
<span>                               x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">fm</span><span class="op">)</span>, fixed <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, </span>
<span>                   <span class="st">"fm_name"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span>pattern <span class="op">=</span> <span class="st">" "</span>, replacement <span class="op">=</span> <span class="st">"_"</span>, </span>
<span>                                    x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">fm</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, </span>
<span>    by <span class="op">=</span> <span class="st">"fm_name"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">comb</span></span></code></pre></div>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">models</span> <span class="op">&lt;-</span> <span class="va">fittimes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">comb</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Fitting "</span>,<span class="va">comb</span><span class="op">$</span><span class="va">SPECIES</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="st">"\n"</span>, <span class="va">comb</span><span class="op">$</span><span class="va">fm_name</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="st">": "</span>, <span class="va">comb</span><span class="op">$</span><span class="va">fm</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">temp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">comb</span><span class="op">$</span><span class="va">SPECIES</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="st">" "</span>, <span class="va">comb</span><span class="op">$</span><span class="va">fm_name</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">fittimes</span><span class="op">[[</span> <span class="va">temp</span> <span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span> <span class="op">(</span> <span class="va">models</span><span class="op">[[</span> <span class="va">temp</span> <span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span></span>
<span>                      <span class="fu">mgcv</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/gam.html" class="external-link">gam</a></span><span class="op">(</span><span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/formula.html" class="external-link">as.formula</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"wCPUE ~ "</span>, <span class="va">comb</span><span class="op">$</span><span class="va">fm</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      dat <span class="op">=</span> <span class="va">dat_wrangled</span>, </span>
<span>      family <span class="op">=</span> <span class="fu">mgcv</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/mgcv/man/Tweedie.html" class="external-link">tw</a></span>, </span>
<span>      gamma <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>  <span class="op">)</span></span>
<span><span class="op">}</span>  </span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/save.html" class="external-link">save</a></span><span class="op">(</span><span class="va">models</span>, <span class="va">fittimes</span>, file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"../inst/VigA_simple_gam_model_fits.Rdata"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Lesson 8: Modling</span></span>
<span><span class="co"># Created by: Emily Markowitz</span></span>
<span><span class="co"># Contact: Emily.Markowitz@noaa.gov</span></span>
<span><span class="co"># Created: 2020-12-18</span></span>
<span><span class="co"># Modified: 2021-02-17</span></span>
<span></span>
<span></span>
<span><span class="co"># tasks -------------------------------------------------------------------</span></span>
<span></span>
<span><span class="co"># Be creative! </span></span>
<span><span class="co"># Make a lm(), glm(), and gam() using either of these datasets to answer a </span></span>
<span><span class="co"># question you have about the data. Be prepared to share your cool code with </span></span>
<span><span class="co"># the class! </span></span>
<span></span>
<span></span>
<span></span>
<span><span class="co"># 3. lm() models --------------- </span></span>
<span></span>
<span><span class="co"># Quickly, I am going to show you all of the combinations using the purrr::map() again:</span></span>
<span></span>
<span><span class="va">lm_mods</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/maps/man/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">dat</span>, <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">wtcpue</span> <span class="op">~</span> <span class="va">.x</span>, data <span class="op">=</span> <span class="va">dat</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>                 <span class="fu">broom</span><span class="fu">::</span><span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html" class="external-link">tidy</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">lm_mods</span> </span>
<span><span class="co"># The best model looks to be the one with longitude!</span></span>
<span></span>
<span><span class="co"># Another way of looking at this:</span></span>
<span></span>
<span><span class="co"># p-values</span></span>
<span><span class="va">dat</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/maps/man/map.html" class="external-link">map</a></span><span class="op">(</span><span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">wtcpue</span> <span class="op">~</span> <span class="va">.x</span>, data <span class="op">=</span> <span class="va">dat</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/maps/man/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">summary</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/maps/man/map.html" class="external-link">map</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"coefficients"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu">map_dbl</span><span class="op">(</span><span class="fl">8</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># r2</span></span>
<span><span class="va">dat</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/maps/man/map.html" class="external-link">map</a></span><span class="op">(</span><span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">wtcpue</span> <span class="op">~</span> <span class="va">.x</span>, data <span class="op">=</span> <span class="va">dat</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/maps/man/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">summary</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/maps/man/map.html" class="external-link">map</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"r.squared"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 4. glm() models --------------- </span></span>
<span></span>
<span><span class="va">glm_fit1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">wtcpue</span> <span class="op">~</span> <span class="va">longitude</span>, </span>
<span>                family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">gaussian</a></span><span class="op">(</span>link <span class="op">=</span> <span class="st">"identity"</span><span class="op">)</span>, <span class="co"># same as an lm()</span></span>
<span>                <span class="co"># family = "gaussian", # *same as line above</span></span>
<span>                data <span class="op">=</span> <span class="va">dat</span><span class="op">)</span></span>
<span></span>
<span><span class="va">glm_fit2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">wtcpue</span> <span class="op">~</span> <span class="va">longitude</span>, </span>
<span>                family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">Gamma</a></span><span class="op">(</span><span class="op">)</span>, </span>
<span>                data <span class="op">=</span> <span class="va">dat</span><span class="op">)</span></span>
<span></span>
<span><span class="va">glm_fit3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">wtcpue</span> <span class="op">~</span> <span class="va">longitude</span> <span class="op">+</span> <span class="va">latitude</span>, </span>
<span>                family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">gaussian</a></span><span class="op">(</span>link <span class="op">=</span> <span class="st">"identity"</span><span class="op">)</span>, <span class="co"># same as an lm()</span></span>
<span>                <span class="co"># family = "gaussian", # *same as line above</span></span>
<span>                data <span class="op">=</span> <span class="va">dat</span><span class="op">)</span></span>
<span></span>
<span><span class="va">glm_fit4</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">wtcpue</span> <span class="op">~</span> <span class="va">longitude</span> <span class="op">+</span> <span class="va">latitude</span>, </span>
<span>                family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">Gamma</a></span><span class="op">(</span><span class="op">)</span>, </span>
<span>                data <span class="op">=</span> <span class="va">dat</span><span class="op">)</span></span>
<span></span>
<span><span class="va">glm_fit5</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">wtcpue</span> <span class="op">~</span> <span class="va">longitude</span> <span class="op">+</span> <span class="va">latitude</span> <span class="op">+</span> <span class="va">year</span>, </span>
<span>                family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">gaussian</a></span><span class="op">(</span>link <span class="op">=</span> <span class="st">"identity"</span><span class="op">)</span>, <span class="co"># same as an lm()</span></span>
<span>                <span class="co"># family = "gaussian", # *same as line above</span></span>
<span>                data <span class="op">=</span> <span class="va">dat</span><span class="op">)</span></span>
<span></span>
<span><span class="va">glm_fit6</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">wtcpue</span> <span class="op">~</span> <span class="va">longitude</span> <span class="op">+</span> <span class="va">latitude</span> <span class="op">+</span> <span class="va">year</span>, </span>
<span>                family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">Gamma</a></span><span class="op">(</span><span class="op">)</span>, </span>
<span>                data <span class="op">=</span> <span class="va">dat</span><span class="op">)</span></span>
<span></span>
<span><span class="va">glm_fit7</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">wtcpue</span> <span class="op">~</span> <span class="va">longitude</span> <span class="op">+</span> <span class="va">latitude</span> <span class="op">+</span> <span class="va">year</span> <span class="op">+</span> <span class="va">bot_temp</span>, </span>
<span>                family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">gaussian</a></span><span class="op">(</span>link <span class="op">=</span> <span class="st">"identity"</span><span class="op">)</span>, <span class="co"># same as an lm()</span></span>
<span>                <span class="co"># family = "gaussian", # *same as line above</span></span>
<span>                data <span class="op">=</span> <span class="va">dat</span><span class="op">)</span></span>
<span></span>
<span><span class="va">glm_fit8</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">wtcpue</span> <span class="op">~</span> <span class="va">longitude</span> <span class="op">+</span> <span class="va">latitude</span> <span class="op">+</span> <span class="va">year</span> <span class="op">+</span> <span class="va">bot_temp</span>, </span>
<span>                family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">Gamma</a></span><span class="op">(</span><span class="op">)</span>, </span>
<span>                data <span class="op">=</span> <span class="va">dat</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/AIC.html" class="external-link">AIC</a></span><span class="op">(</span><span class="va">glm_fit1</span>, <span class="va">glm_fit2</span>, <span class="va">glm_fit3</span>, <span class="va">glm_fit4</span>, </span>
<span>    <span class="va">glm_fit5</span>, <span class="va">glm_fit6</span>, <span class="va">glm_fit7</span>, <span class="va">glm_fit8</span><span class="op">)</span></span>
<span><span class="co"># Model 6 has the lowest AIC and is the most parsimonious!</span></span>
<span><span class="co"># bot_temp did not improve the model at all here, so why include it?</span></span>
<span><span class="co"># AIC is not the only metric to consider here, but I'll let you read up on that!</span></span>
<span><span class="co"># we can see that this model has room for improvement from looking at the plots: </span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">glm_fit6</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Now let's predict our outputs</span></span>
<span></span>
<span><span class="co"># make up x</span></span>
<span><span class="va">pred</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="st">"longitude"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">30</span>, </span>
<span>                                     mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">longitude</span><span class="op">)</span>, </span>
<span>                                     sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">longitude</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                 <span class="st">"latitude"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">30</span>, </span>
<span>                                    mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">latitude</span><span class="op">)</span>, </span>
<span>                                    sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">latitude</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                 <span class="st">"year"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep_len</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2016</span>, <span class="fl">2017</span>, <span class="fl">2018</span><span class="op">)</span>, </span>
<span>                                  length.out <span class="op">=</span> <span class="fl">10</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># predict y with your equation</span></span>
<span><span class="va">pred</span><span class="op">$</span><span class="va">x</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">glm_fit6</span>, </span>
<span>                newdata <span class="op">=</span> <span class="va">pred</span>, </span>
<span>                type <span class="op">=</span> <span class="st">"response"</span><span class="op">)</span></span>
<span><span class="va">pred</span></span>
<span></span>
<span><span class="co"># 5. gam() models --------------- </span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">mgcv</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create our gam models</span></span>
<span><span class="va">gam_fit1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/gam.html" class="external-link">gam</a></span><span class="op">(</span></span>
<span>  <span class="va">wtcpue</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s</a></span><span class="op">(</span><span class="va">longitude</span><span class="op">)</span>, </span>
<span>  data <span class="op">=</span> <span class="va">dat</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">gam_fit2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/gam.html" class="external-link">gam</a></span><span class="op">(</span></span>
<span>  <span class="va">wtcpue</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s</a></span><span class="op">(</span><span class="va">longitude</span><span class="op">)</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">Gamma</a></span><span class="op">(</span>link<span class="op">=</span><span class="va">log</span><span class="op">)</span>, </span>
<span>  data <span class="op">=</span> <span class="va">dat</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">gam_fit3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/gam.html" class="external-link">gam</a></span><span class="op">(</span></span>
<span>  <span class="va">wtcpue</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s</a></span><span class="op">(</span><span class="va">longitude</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s</a></span><span class="op">(</span><span class="va">latitude</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">dat</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">gam_fit4</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/gam.html" class="external-link">gam</a></span><span class="op">(</span></span>
<span>  <span class="va">wtcpue</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s</a></span><span class="op">(</span><span class="va">longitude</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s</a></span><span class="op">(</span><span class="va">latitude</span><span class="op">)</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">Gamma</a></span><span class="op">(</span>link<span class="op">=</span><span class="va">log</span><span class="op">)</span>, </span>
<span>  data <span class="op">=</span> <span class="va">dat</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">gam_fit5</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/gam.html" class="external-link">gam</a></span><span class="op">(</span></span>
<span>  <span class="va">wtcpue</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s</a></span><span class="op">(</span><span class="va">longitude</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s</a></span><span class="op">(</span><span class="va">latitude</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s</a></span><span class="op">(</span><span class="va">year</span>, k <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">dat</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">gam_fit6</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/gam.html" class="external-link">gam</a></span><span class="op">(</span></span>
<span>  <span class="va">wtcpue</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s</a></span><span class="op">(</span><span class="va">longitude</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s</a></span><span class="op">(</span><span class="va">latitude</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s</a></span><span class="op">(</span><span class="va">year</span>, k <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">Gamma</a></span><span class="op">(</span>link<span class="op">=</span><span class="va">log</span><span class="op">)</span>, </span>
<span>  data <span class="op">=</span> <span class="va">dat</span></span>
<span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">gam_fit7</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/gam.html" class="external-link">gam</a></span><span class="op">(</span></span>
<span>  <span class="va">wtcpue</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s</a></span><span class="op">(</span><span class="va">longitude</span>, <span class="va">latitude</span>, <span class="va">year</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">dat</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">gam_fit8</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/gam.html" class="external-link">gam</a></span><span class="op">(</span></span>
<span>  <span class="va">wtcpue</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s</a></span><span class="op">(</span><span class="va">longitude</span>, <span class="va">latitude</span>, <span class="va">year</span><span class="op">)</span>, </span>
<span>  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">Gamma</a></span><span class="op">(</span>link<span class="op">=</span><span class="va">log</span><span class="op">)</span>, </span>
<span>  data <span class="op">=</span> <span class="va">dat</span></span>
<span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/AIC.html" class="external-link">AIC</a></span><span class="op">(</span><span class="va">gam_fit1</span>, <span class="va">gam_fit2</span>, <span class="va">gam_fit3</span>, <span class="va">gam_fit4</span>, </span>
<span>    <span class="va">gam_fit5</span>, <span class="va">gam_fit6</span>, <span class="va">gam_fit7</span>, <span class="va">gam_fit8</span><span class="op">)</span></span>
<span><span class="co"># Model 8 has the lowest AIC! </span></span>
<span><span class="co"># by explicityly making a spatio-temporal term (as opposed to assessing </span></span>
<span><span class="co"># each sepeately) we were able to obtain a better model</span></span>
<span><span class="co"># Again, AIC is not the only metric to consider here, but I'll let you read up on that!</span></span>
<span></span>
<span></span>
<span><span class="co"># crazy, just for giggles (aka an abridged model I am playing with in real life!)</span></span>
<span><span class="va">gam_fit9</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/gam.html" class="external-link">gam</a></span><span class="op">(</span></span>
<span>  <span class="va">wtcpue</span> <span class="op">~</span> <span class="va">year</span> <span class="op">+</span> <span class="co"># a linear variable</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s</a></span><span class="op">(</span><span class="va">longitude</span>, <span class="va">latitude</span>, bs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'ts'</span><span class="op">)</span>, k <span class="op">=</span> <span class="fl">379</span><span class="op">)</span> <span class="op">+</span> <span class="co"># ts = tensor spline, k = knots, here the number of stations (?)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s</a></span><span class="op">(</span><span class="va">longitude</span>, <span class="va">latitude</span>,bs<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'ts'</span><span class="op">)</span>,k<span class="op">=</span><span class="fl">50</span>, by<span class="op">=</span><span class="va">year</span>, id<span class="op">=</span><span class="fl">1</span><span class="op">)</span>, <span class="co"># the above but with a by year term</span></span>
<span>  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">Gamma</a></span><span class="op">(</span>link<span class="op">=</span><span class="va">log</span><span class="op">)</span>, </span>
<span>  data <span class="op">=</span> <span class="va">dat</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Will this more developed model be better than our gam_fit8?</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/AIC.html" class="external-link">AIC</a></span><span class="op">(</span><span class="va">gam_fit8</span>, <span class="va">gam_fit9</span><span class="op">)</span></span>
<span><span class="co"># Our new gam_fit9 is just that much better than our gam_fit8! </span></span></code></pre></div>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/AIC.html" class="external-link">AIC</a></span><span class="op">(</span><span class="va">models</span><span class="op">$</span><span class="va">`walleye pollock fm_1_s_t_st`</span><span class="op">$</span><span class="va">pModels</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, </span>
<span>    <span class="va">models</span><span class="op">$</span><span class="va">`walleye pollock fm_2_cov`</span><span class="op">$</span><span class="va">pModels</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">models</span>,<span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/gam.check.html" class="external-link">gam.check</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">pModels</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">models</span>,<span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">pModels</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="indicies-of-abundance">8. Indicies of Abundance<a class="anchor" aria-label="anchor" href="#indicies-of-abundance"></a>
</h2>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dat_design</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span>file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"YFS_10210_estimate_summary.csv"</span>, </span>
<span>                        package <span class="op">=</span> <span class="st">"sdmgamindex"</span> <span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>                          <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>common_name <span class="op">=</span> <span class="st">"yellowfin sole"</span><span class="op">)</span>,</span>
<span>                 <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span>file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"WEP_21740_estimate_summary.csv"</span>, </span>
<span>                        package <span class="op">=</span> <span class="st">"sdmgamindex"</span> <span class="op">)</span><span class="op">)</span>  <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>                          <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>common_name <span class="op">=</span> <span class="st">"walleye pollock"</span><span class="op">)</span>, </span>
<span>                 <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span>file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"RKC_Table_for_SS3.csv"</span>, </span>
<span>                        package <span class="op">=</span> <span class="st">"sdmgamindex"</span> <span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>design_mt <span class="op">=</span> <span class="va">Estimate_metric_tons</span>, </span>
<span>                design_se <span class="op">=</span> <span class="va">SD_mt</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>design_se <span class="op">=</span> <span class="op">(</span><span class="va">design_se</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span>, </span>
<span>                design_CV <span class="op">=</span> <span class="cn">NA</span>, </span>
<span>                VAST_mt <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>                VAST_se <span class="op">=</span> <span class="cn">NA</span>, </span>
<span>                VAST_CV <span class="op">=</span> <span class="cn">NA</span>, </span>
<span>                common_name <span class="op">=</span> <span class="st">"red king crab"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">Unit</span>, <span class="op">-</span><span class="va">Fleet</span>, <span class="op">-</span><span class="va">SD_log</span><span class="op">)</span><span class="op">)</span> </span>
<span></span>
<span></span>
<span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">models</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">temp</span> <span class="op">&lt;-</span> <span class="va">models</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="va">dat0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>idx <span class="op">=</span> <span class="va">temp</span><span class="op">$</span><span class="va">idx</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>, </span>
<span>                     lo <span class="op">=</span> <span class="va">temp</span><span class="op">$</span><span class="va">lo</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>, </span>
<span>                     up <span class="op">=</span> <span class="va">temp</span><span class="op">$</span><span class="va">up</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>,</span>
<span>                     Year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">temp</span><span class="op">$</span><span class="va">idx</span><span class="op">)</span>, </span>
<span>                     group <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">models</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,</span>
<span>                     formula <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"cpue_kgha ~ "</span>, </span>
<span>                                      <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">temp</span><span class="op">$</span><span class="va">pModels</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">formula</span><span class="op">)</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">dat</span>, <span class="va">dat0</span><span class="op">)</span> </span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">dat</span><span class="op">$</span><span class="va">common_name</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span>X <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/strsplit.html" class="external-link">strsplit</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">dat</span><span class="op">$</span><span class="va">group</span>, split <span class="op">=</span> <span class="st">" fm"</span><span class="op">)</span>, <span class="va">`[`</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">dat</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>                          <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">Year</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>                          <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">group</span><span class="op">)</span>, </span>
<span>                        <span class="va">dat_design</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>                          <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">design_mt</span>, <span class="va">common_name</span>, <span class="va">Year</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>                          <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>idx <span class="op">=</span> <span class="va">design_mt</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>                          <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>lo <span class="op">=</span> <span class="cn">NA</span>, </span>
<span>                                        up <span class="op">=</span> <span class="cn">NA</span>, </span>
<span>                                        formula <span class="op">=</span> <span class="st">"design"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">Year</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">YEARS</span><span class="op">)</span></span>
<span>  </span>
<span></span>
<span><span class="va">dat</span><span class="op">[</span><span class="va">dat</span><span class="op">$</span><span class="va">Year</span> <span class="op">==</span> <span class="fl">2020</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"idx"</span>, <span class="st">"up"</span>, <span class="st">"lo"</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span></span>
<span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">dat</span>, </span>
<span>                mapping <span class="op">=</span> <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">Year</span>, </span>
<span>                              y <span class="op">=</span> <span class="va">idx</span>, </span>
<span>                              group <span class="op">=</span> <span class="va">formula</span>, </span>
<span>                              color <span class="op">=</span> <span class="va">formula</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_line</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_point</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>  <span class="op">+</span> </span>
<span>  <span class="fu">geom_ribbon</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">lo</span>, ymax <span class="op">=</span> <span class="va">up</span>, fill <span class="op">=</span> <span class="va">formula</span><span class="op">)</span>, </span>
<span>              alpha<span class="op">=</span><span class="fl">0.1</span>, </span>
<span>              linetype<span class="op">=</span><span class="st">"dashed"</span>,</span>
<span>              color<span class="op">=</span><span class="st">"grey"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"Annual Index Model Results"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="fu">vars</span><span class="op">(</span><span class="va">common_name</span><span class="op">)</span>, scales <span class="op">=</span> <span class="st">"free"</span>, ncol <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span>, </span>
<span>        legend.direction <span class="op">=</span> <span class="st">"vertical"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="predict-and-plot">9. Predict and plot<a class="anchor" aria-label="anchor" href="#predict-and-plot"></a>
</h2>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">dat_pred</span> <span class="op">&lt;-</span> <span class="va">dat_catch_haul</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">Year</span>, <span class="va">sx</span>, <span class="va">sy</span>, <span class="va">Lon</span>, <span class="va">Lat</span>, <span class="va">GEAR_TEMPERATURE</span>, <span class="va">BOTTOM_DEPTH</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">models</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">temp</span> <span class="op">&lt;-</span> <span class="va">models</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="va">dat0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>idx <span class="op">=</span> </span>
<span>                 <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/predict.gam.html" class="external-link">predict.gam</a></span><span class="op">(</span></span>
<span>                   object <span class="op">=</span> <span class="va">temp</span><span class="op">$</span><span class="va">pModels</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>,</span>
<span>                   newdata <span class="op">=</span> <span class="va">dat_pred</span><span class="op">)</span>,  </span>
<span>                     group <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">models</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, </span>
<span>                     formula <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"cpue_kgha ~ "</span>, </span>
<span>                                      <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">temp</span><span class="op">$</span><span class="va">pModels</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">formula</span><span class="op">)</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>               <span class="op">)</span></span>
<span>  <span class="va">dat00</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_cols.html" class="external-link">bind_cols</a></span><span class="op">(</span><span class="va">dat0</span>, <span class="va">dat_pred</span><span class="op">)</span> </span>
<span>  <span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">dat</span>, <span class="va">dat00</span><span class="op">)</span> </span>
<span>  </span>
<span><span class="co"># dat_r &lt;- raster::rasterFromXYZ(xyz = dat00[,c("lon", "lat", "idx")])</span></span>
<span>    </span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">dat</span><span class="op">$</span><span class="va">facet_group</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span>X <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/strsplit.html" class="external-link">strsplit</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">dat</span><span class="op">$</span><span class="va">group</span>, split <span class="op">=</span> <span class="st">" fm"</span><span class="op">)</span>, <span class="va">`[`</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">facet_group</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  </span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">dat</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>                  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">facet_group</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">facet_group</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span>, </span>
<span>                mapping <span class="op">=</span> <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">Lon</span>, </span>
<span>                              y <span class="op">=</span> <span class="va">Lat</span>, </span>
<span>                              group <span class="op">=</span> <span class="va">group</span>, </span>
<span>                              color <span class="op">=</span> <span class="va">idx</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">scale_color_viridis_c</span><span class="op">(</span>option <span class="op">=</span> <span class="st">"D"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span><span class="op">)</span>  <span class="op">+</span> </span>
<span>  <span class="fu">ggtitle</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Annual Index Model Results for "</span>, <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">facet_group</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_grid</span><span class="op">(</span>cols <span class="op">=</span> <span class="fu">vars</span><span class="op">(</span><span class="va">group</span><span class="op">)</span>, </span>
<span>             rows <span class="op">=</span> <span class="fu">vars</span><span class="op">(</span><span class="va">Year</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span></span>
<span>  </span>
<span><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu">sdmgamindex</span><span class="fu">::</span><span class="fu"><a href="../reference/plot_surveyidx.html">plot_surveyidx</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="va">models</span>, </span>
<span>  dat <span class="op">=</span> <span class="va">ds</span>, </span>
<span>  myids <span class="op">=</span> <span class="cn">NULL</span>, </span>
<span>  predD <span class="op">=</span> <span class="va">allpd</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="simulations">10. Simulations<a class="anchor" aria-label="anchor" href="#simulations"></a>
</h2>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">REPS</span> <span class="op">&lt;-</span> <span class="fl">4</span></span>
<span><span class="va">ests</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">comb</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Simulating "</span>,<span class="va">comb</span><span class="op">$</span><span class="va">SPECIES</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="st">"\n"</span>, <span class="va">comb</span><span class="op">$</span><span class="va">fm_name</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="st">": "</span>, <span class="va">comb</span><span class="op">$</span><span class="va">fm</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span>  <span class="va">temp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">comb</span><span class="op">$</span><span class="va">SPECIES</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="st">" "</span>, <span class="va">comb</span><span class="op">$</span><span class="va">fm_name</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># for(SPECIES in specLevels){</span></span>
<span>  <span class="va">ests</span><span class="op">[[</span> <span class="va">temp</span> <span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## simulate data</span></span>
<span>  <span class="va">csim</span> <span class="op">&lt;-</span> <span class="fu">sdmgamindex</span><span class="fu">::</span><span class="fu"><a href="../reference/get_surveyidx_sim.html">get_surveyidx_sim</a></span><span class="op">(</span><span class="va">models</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>, <span class="va">ds</span><span class="op">[[</span><span class="va">comb</span><span class="op">$</span><span class="va">SPECIES</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">sims</span> <span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">REPS</span>,<span class="kw">function</span><span class="op">(</span><span class="va">j</span><span class="op">)</span> <span class="fu">sdmgamindex</span><span class="fu">::</span><span class="fu"><a href="../reference/get_surveyidx_sim.html">get_surveyidx_sim</a></span><span class="op">(</span></span>
<span>    model <span class="op">=</span> <span class="va">models</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>,</span>
<span>    d <span class="op">=</span> <span class="va">ds</span><span class="op">[[</span><span class="va">comb</span><span class="op">$</span><span class="va">SPECIES</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">]</span>, </span>
<span>    sampleFit <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    condSim <span class="op">=</span> <span class="va">csim</span><span class="op">)</span> <span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## re-estimate</span></span>
<span>  <span class="va">tmp</span> <span class="op">&lt;-</span> <span class="va">ds</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">REPS</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">tmp</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">Nage</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="va">sims</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>,ncol<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">tmp</span><span class="op">$</span><span class="va">Nage</span><span class="op">)</span><span class="op">&lt;-</span><span class="fl">1</span></span>
<span>    </span>
<span>    <span class="va">ests</span><span class="op">[[</span><span class="va">SPECIES</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>  <span class="op">&lt;-</span></span>
<span>      <span class="fu">sdmgamindex</span><span class="fu">::</span><span class="fu"><a href="../reference/get_surveyidx.html">get_surveyidx</a></span><span class="op">(</span></span>
<span>        x <span class="op">=</span> <span class="va">tmp</span>,</span>
<span>        ages <span class="op">=</span> <span class="fl">1</span>,</span>
<span>        myids<span class="op">=</span><span class="cn">NULL</span>,</span>
<span>        predD<span class="op">=</span><span class="va">allpd</span>,</span>
<span>        cutOff<span class="op">=</span><span class="fl">0</span>,</span>
<span>        fam<span class="op">=</span><span class="st">"Tweedie"</span>,</span>
<span>        modelP<span class="op">=</span><span class="va">fm</span>,</span>
<span>        gamma<span class="op">=</span><span class="fl">1</span>,</span>
<span>        control<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>trace<span class="op">=</span><span class="cn">TRUE</span>,maxit<span class="op">=</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="co"># cat(i, " done.\n")</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grDevices/png.html" class="external-link">png</a></span><span class="op">(</span><span class="st">"simest.png"</span>,width<span class="op">=</span><span class="fl">640</span><span class="op">*</span><span class="va">pngscal</span>,height<span class="op">=</span><span class="fl">480</span><span class="op">*</span><span class="va">pngscal</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">comb</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span></span>
<span><span class="co"># for(SPECIES in specLevels){</span></span>
<span>  <span class="fu">sdmgamindex</span><span class="fu">::</span><span class="fu"><a href="../reference/plot_simulation_list.html">plot_simulation_list</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="va">ests</span><span class="op">[[</span><span class="va">temp</span><span class="op">]</span><span class="op">]</span>,</span>
<span>    base<span class="op">=</span><span class="va">models</span><span class="op">[[</span><span class="va">temp</span><span class="op">]</span><span class="op">]</span>,</span>
<span>    main<span class="op">=</span><span class="va">temp</span>,</span>
<span>    lwd<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grDevices/dev.html" class="external-link">dev.off</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
